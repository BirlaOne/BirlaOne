<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://i.ibb.co/N6QNPW56/logo-1-modified.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Web App Manifest (for PWA-like features) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <title>BirlaOne Search</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        logo: ['Pacifico', 'cursive'],
                    },
                    colors: {
                        'primary': { '50': '#f7fbf4','100': '#eef8e9','200': '#dcf1d3','300': '#c3e7b3','400': '#a6d98e','500': '#87c964','600': '#56ab2f','700': '#458a26','800': '#396f21','900': '#305b1c','950': '#1a320f' },
                        'danger': { '50': '#ffebee', '100': '#ffcdd2', '200': '#ef9a9a','300': '#e57373', '400': '#ef5350', '500': '#f44336','600': '#e53935', '700': '#d32f2f', '800': '#c62828','900': '#b71c1c', '950': '#8d1111' }
                    }
                },
            },
        };
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; /* bg-slate-50 */ }
        .top-nav-shadow { box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.03); }
        .bottom-nav-shadow { box-shadow: 0 -4px 10px -1px rgba(0, 0, 0, 0.03); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        i[data-feather], svg.feather { width: 24px; height: 24px; stroke: currentColor; }
        .bottom-nav-icon i[data-feather], .bottom-nav-icon svg.feather { width: 28px; height: 28px; }
        .tick-mark-search { width: 1rem; height: 1rem; vertical-align: middle; margin-left: 4px; display: inline-block; }
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: #56ab2f; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(300deg); } }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- Shimmer Loader Styles --- */
        .shimmer-wrapper {
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* --- Toast Notifications --- */
        #toast-container { position: fixed; bottom: 1rem; left: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; pointer-events: none; }
        .toast { display: flex; align-items: center; width: 100%; max-width: 400px; padding: 0.75rem 1rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); animation: toast-in 0.3s ease-in-out; opacity: 0; pointer-events: all; }
        .toast.toast-success { background-color: #305b1c; color: #eef8e9; }
        .toast.toast-error { background-color: #b71c1c; color: #ffcdd2; }
        .toast.show { opacity: 1; }
        .toast-icon { width: 20px; height: 20px; margin-right: 0.75rem; }
        @keyframes toast-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased">

    <div class="relative min-h-screen w-full md:max-w-md md:mx-auto md:shadow-2xl md:overflow-hidden bg-white">

        <main class="pb-28 overflow-y-auto h-screen no-scrollbar">
            
            <div class="sticky top-0 z-30 bg-white/95 backdrop-blur-sm top-nav-shadow p-4 space-y-4">
                <h1 class="text-3xl font-bold text-gray-900">Search</h1>
                <div class="relative flex items-center">
                    <i data-feather="search" class="absolute left-4 w-5 h-5 text-gray-400 z-10"></i>
                    <input id="search-input" type="text" placeholder="Search for students..." class="relative w-full bg-gray-100 border border-gray-200 rounded-xl py-3 pr-4 pl-12 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-transparent">
                </div>
            </div>

            <div class="p-4 space-y-4">
                <!-- Popular Section -->
                <div id="popular-section">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Popular</h2>
                    <!-- Shimmer loaders will be injected here -->
                    <div id="popular-users-list" class="space-y-3"></div>
                </div>

                <!-- Search Results Section -->
                <div id="search-results-section" class="hidden">
                     <h2 class="text-lg font-semibold text-gray-700 mb-3">Results</h2>
                     <!-- Shimmer loaders or "no results" will be injected here -->
                     <div id="search-results-list" class="space-y-3">
                         <div id="no-results" class="text-center text-gray-500 py-4 hidden">No users found.</div>
                     </div>
                </div>
            </div>

        </main>

        <!-- Bottom Nav -->
        <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white/95 backdrop-blur-sm bottom-nav-shadow p-3 flex justify-around items-center md:max-w-md md:mx-auto h-20">
            <a href="index.html" class="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-primary-600 transition-colors bottom-nav-icon" aria-label="Dashboard"> <i data-feather="layout"></i> </a>
            <a href="feed.html" class="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-primary-600 transition-colors bottom-nav-icon" aria-label="Feed"> <i data-feather="file-text"></i> </a>
            <a href="create.html" class="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-primary-600 transition-colors bottom-nav-icon" aria-label="Create"> <i data-feather="plus-circle"></i> </a>
            <a href="search.html" class="flex flex-col items-center justify-center p-2 text-primary-600 rounded-lg bottom-nav-icon" aria-label="Search"> <i data-feather="search" class="stroke-[2.5px]"></i> </a>
            <a href="apps.html" class="flex flex-col items-center justify-center p-2 text-gray-400 hover:text-primary-600 transition-colors bottom-nav-icon" aria-label="Profile"> <i data-feather="grid"></i> </a>
        </nav>

    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // --- Supabase Client & Globals ---
        const SUPABASE_URL = 'https://eikriuddsuguybvvyzjl.supabase.co'; // REPLACE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpa3JpdWRkc3VndXlidnZ5empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjIxNTAsImV4cCI6MjA3MzY5ODE1MH0.HNh2gGO8nWzAjxh5Oa3cs_8WKaq9mq9TyLCvPOkcr2c'; // REPLACE
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentAuthUser = null;
        let searchTimeout;
        const tickImages = { blue: "https://i.ibb.co/kgJpMCHr/blue.png", silver: "https://i.ibb.co/gLJLF9Z2/silver.png", gold: "https://i.ibb.co/Q2C7MrM/gold.png", black: "https://i.ibb.co/zVNSNzrK/black.png", green: "https://i.ibb.co/SXGL4Nq0/green.png" };
        const CACHE_TTL_MINUTES = 30; // Cache data for 30 minutes

        // --- DOM Elements ---
        const searchInput = document.getElementById('search-input');
        const popularSection = document.getElementById('popular-section');
        const popularUsersList = document.getElementById('popular-users-list');
        const searchResultsSection = document.getElementById('search-results-section');
        const searchResultsList = document.getElementById('search-results-list');
        const noResults = document.getElementById('no-results');
        const toastContainer = document.getElementById('toast-container');


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            feather.replace(); // Initial icon render

            // --- Service Worker Registration ---
            // Note: This requires a 'sw.js' file in your root directory.
            // I can help generate that file in a follow-up.
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    }).catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            }

            const { data: { session }, error } = await _supabase.auth.getSession();
            if (error || !session) { 
                window.location.href = 'login.html'; // Redirect if not logged in
                return; 
            }
            currentAuthUser = session.user;
            
            await fetchPopularUsers();
            setupEventListeners();
        });

        // --- Event Listeners ---
        function setupEventListeners() {
            // Search Input Listener with Debounce
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const searchTerm = searchInput.value.trim();
                
                // Show popular if search is cleared
                if (!searchTerm) {
                    popularSection.style.display = 'block';
                    searchResultsSection.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    performSearch(searchTerm);
                }, 300); // Wait 300ms after user stops typing
            });

             // Event Delegation for Add Friend Buttons
            document.body.addEventListener('click', async (event) => {
                const addButton = event.target.closest('.add-friend-btn');
                if (addButton && !addButton.disabled) {
                    const targetUserId = addButton.dataset.userId;
                    await sendFriendRequest(targetUserId, addButton);
                }
            });
        }

        // --- Caching Utility Functions ---

        /**
         * Sets data in localStorage with a timestamp and TTL.
         * @param {string} key - The key for the cache.
         * @param {any} data - The data to store.
         * @param {number} ttlMinutes - Time-to-live in minutes.
         */
        function setCache(key, data, ttlMinutes) {
            try {
                const item = {
                    data: data,
                    timestamp: Date.now(),
                    expires: Date.now() + ttlMinutes * 60 * 1000
                };
                localStorage.setItem(key, JSON.stringify(item));
            } catch (e) {
                console.error("Error setting cache:", e);
                // Can happen if localStorage is full
            }
        }

        /**
         * Gets data from localStorage if it exists and hasn't expired.
         * @param {string} key - The key for the cache.
         * @returns {any|null} The cached data or null.
         */
        function getCache(key) {
            try {
                const itemStr = localStorage.getItem(key);
                if (!itemStr) {
                    return null;
                }
                const item = JSON.parse(itemStr);
                if (Date.now() > item.expires) {
                    localStorage.removeItem(key); // Cache expired
                    return null;
                }
                return item.data;
            } catch (e) {
                console.error("Error getting cache:", e);
                return null;
            }
        }


        // --- Shimmer/Skeleton Loader Functions ---

        /**
         * Renders a number of shimmer placeholders into a container.
         * @param {HTMLElement} container - The list element to fill.
         * @param {number} count - The number of shimmer items to create.
         */
        function renderShimmers(container, count = 3) {
            container.innerHTML = Array(count).fill(createUserItemShimmerHTML()).join('');
        }

        /**
         * Returns the HTML for a single shimmer placeholder item.
         */
        function createUserItemShimmerHTML() {
            return `
                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-2xl overflow-hidden">
                    <div class="flex-shrink-0">
                        <div class="w-14 h-14 rounded-full shimmer-wrapper"></div>
                    </div>
                    <div class="flex-1 min-w-0 space-y-2">
                        <div class="h-5 w-3/4 rounded shimmer-wrapper"></div>
                        <div class="h-4 w-1/2 rounded shimmer-wrapper"></div>
                    </div>
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full shimmer-wrapper"></div>
                    </div>
                </div>
            `;
        }

        // --- Search Logic ---
        async function performSearch(searchTerm) {
            popularSection.style.display = 'none';
            searchResultsSection.style.display = 'block';
            noResults.style.display = 'none';

            const cacheKey = `birlaone_search_${searchTerm.toLowerCase()}`;
            const cachedResults = getCache(cacheKey);

            if (cachedResults) {
                console.log("Loading search from cache:", searchTerm);
                if (cachedResults.length === 0) {
                    noResults.style.display = 'block';
                    searchResultsList.innerHTML = '';
                } else {
                    renderUserList(cachedResults.users, searchResultsList, cachedResults.statuses);
                }
                return;
            }

            // --- Show Shimmers ---
            renderShimmers(searchResultsList, 4);

            try {
                const { data: users, error } = await _supabase.from('users')
                    .select('id, auth_id, name, img, course, tick, s_permission')
                    .ilike('name', `%${searchTerm}%`)
                    .eq('s_permission', 'yes')
                    .limit(10);
                
                if (error) throw error;

                if (users.length === 0) {
                    noResults.style.display = 'block';
                    searchResultsList.innerHTML = ''; // Clear shimmers
                    setCache(cacheKey, { users: [], statuses: {} }, CACHE_TTL_MINUTES); // Cache empty result
                } else {
                    const otherUserIds = users.filter(u => u.auth_id !== currentAuthUser.id).map(u => u.auth_id);
                    const friendshipStatuses = await checkMultipleFriendshipStatuses(otherUserIds);
                    
                    // Cache the results
                    setCache(cacheKey, { users, statuses: friendshipStatuses }, CACHE_TTL_MINUTES);
                    
                    // Render the results
                    renderUserList(users, searchResultsList, friendshipStatuses);
                }

            } catch (error) {
                console.error("Error searching users:", error);
                searchResultsList.innerHTML = '<p class="text-center text-red-500">Error performing search.</p>';
            }
            // 'finally' block removed as shimmers are replaced by content or error
        }


        // --- Fetch Popular Users ---
        async function fetchPopularUsers() {
            const cacheKey = 'birlaone_popular';
            const cachedData = getCache(cacheKey);

            if (cachedData) {
                console.log("Loading popular users from cache.");
                if (cachedData.users.length > 0) {
                    renderUserList(cachedData.users, popularUsersList, cachedData.statuses);
                } else {
                    popularUsersList.innerHTML = '<p class="text-center text-gray-500">No popular users found yet.</p>';
                }
                return;
            }

            // --- Show Shimmers ---
            renderShimmers(popularUsersList, 3);
            
            try {
                // Query is already optimized (selects specific columns, filters, orders, limits)
                const { data: users, error } = await _supabase.from('users')
                    .select('id, auth_id, name, img, course, tick, friend_count, s_permission')
                    .gt('friend_count', 0)
                    .eq('s_permission', 'yes')
                    .order('friend_count', { ascending: false })
                    .limit(10); 

                if (error) throw error;
                
                if (users.length > 0) {
                    const otherUserIds = users.filter(u => u.auth_id !== currentAuthUser.id).map(u => u.auth_id);
                    const friendshipStatuses = await checkMultipleFriendshipStatuses(otherUserIds);
                    
                    // Cache the data
                    setCache(cacheKey, { users, statuses: friendshipStatuses }, CACHE_TTL_MINUTES);
                    
                    // Render the data
                    renderUserList(users, popularUsersList, friendshipStatuses);
                } else {
                    popularUsersList.innerHTML = '<p class="text-center text-gray-500">No popular users found yet.</p>';
                    setCache(cacheKey, { users: [], statuses: {} }, CACHE_TTL_MINUTES); // Cache empty result
                }

            } catch (error) {
                console.error("Error fetching popular users:", error);
                popularUsersList.innerHTML = '<p class="text-center text-red-500">Could not load popular users.</p>';
            }
        }

        // --- Render User List ---
        function renderUserList(users, container, friendshipStatuses) {
            container.innerHTML = users.map(user => createUserItemHTML(user, friendshipStatuses[user.auth_id])).join('');
            feather.replace(); // Render icons for add buttons etc.
        }
        
        // --- Create Single User Item HTML ---
        // (This function remains unchanged, as its logic is core to the app)
        function createUserItemHTML(user, status) {
            const isCurrentUser = user.auth_id === currentAuthUser.id;
            
            const profileUrl = `profile.html?id=${user.id}`;
            const avatarUrl = user.img || `https://placehold.co/60x60/DCEFD3/305B1C?text=${user.name ? user.name.charAt(0) : '?'}`;
            const tickType = user.tick?.toLowerCase();
            const tickHtml = (tickType && tickImages[tickType]) 
                ? `<img src="${tickImages[tickType]}" alt="${tickType} tick" class="tick-mark-search">` 
                : '';
            const courseText = user.course ? user.course.toUpperCase() : 'Course not set';
            
            let actionButtonHtml = '';
            if (isCurrentUser) {
                actionButtonHtml = `
                    <span class="p-2 rounded-full text-primary-700 bg-primary-100 font-semibold text-sm px-3">
                        You
                    </span>`;
            } else if (status === 'none') {
                actionButtonHtml = `
                    <button class="add-friend-btn p-2 rounded-full text-primary-600 bg-primary-100 hover:bg-primary-200 transition-all active:scale-90" data-user-id="${user.auth_id}" title="Add Friend">
                        <i data-feather="user-plus" class="w-5 h-5"></i>
                    </button>`;
            } else if (status === 'pending_sent') {
                 actionButtonHtml = `
                    <button class="p-2 rounded-full text-gray-500 bg-gray-200 cursor-not-allowed" disabled title="Request Sent">
                        <i data-feather="check" class="w-5 h-5"></i>
                    </button>`;
            }

            return `
                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-2xl">
                    <a href="${profileUrl}" class="flex-shrink-0">
                        <img src="${avatarUrl}" alt="${user.name}" class="w-14 h-14 rounded-full border-2 border-primary-200 object-cover">
                    </a>
                    <a href="${profileUrl}" class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-900 truncate flex items-center">
                            ${user.name || 'User'} ${tickHtml}
                        </p>
                        <p class="text-sm text-gray-500 truncate">${courseText}</p>
                    </a>
                    <div class="flex-shrink-0">
                        ${actionButtonHtml}
                    </div>
                </div>
            `;
        }

        // --- Friendship Status Checking ---
        // (This function is already well-optimized by using .in.() and remains unchanged)
        async function checkMultipleFriendshipStatuses(targetUserIds) {
            if (!currentAuthUser || targetUserIds.length === 0) return {};

            const myAuthId = currentAuthUser.id;
            const statuses = {};
            targetUserIds.forEach(id => statuses[id] = 'none'); 

            try {
                // Check existing friendships
                const { data: friendships, error: friendError } = await _supabase.from('friendships')
                    .select('user1_id, user2_id')
                    .or(`and(user1_id.eq.${myAuthId},user2_id.in.(${targetUserIds.join(',')})),and(user2_id.eq.${myAuthId},user1_id.in.(${targetUserIds.join(',')}))`);
                
                if (friendError) throw friendError;
                friendships.forEach(f => {
                    const friendId = f.user1_id === myAuthId ? f.user2_id : f.user1_id;
                    if (statuses[friendId]) statuses[friendId] = 'friends';
                });

                // Check pending friend requests
                const userIdsToCheckRequests = targetUserIds.filter(id => statuses[id] === 'none');
                if (userIdsToCheckRequests.length > 0) {
                    const { data: requests, error: reqError } = await _supabase.from('friend_requests')
                        .select('sender_id, receiver_id, status')
                        .or(`and(sender_id.eq.${myAuthId},receiver_id.in.(${userIdsToCheckRequests.join(',')})),and(receiver_id.eq.${myAuthId},sender_id.in.(${userIdsToCheckRequests.join(',')}))`)
                        .eq('status', 'pending');

                    if (reqError) throw reqError;
                    requests.forEach(req => {
                        const otherUserId = req.sender_id === myAuthId ? req.receiver_id : req.sender_id;
                        if (statuses[otherUserId] === 'none') {
                            statuses[otherUserId] = req.sender_id === myAuthId ? 'pending_sent' : 'pending_received';
                        }
                    });
                }

            } catch (error) {
                console.error("Error checking friendship statuses:", error);
            }
            return statuses;
        }


        // --- Send Friend Request ---
        // (This function remains unchanged, as its logic is core to the app)
        async function sendFriendRequest(targetAuthId, buttonElement) {
            if (!currentAuthUser || !targetAuthId) return;

            buttonElement.disabled = true;
            buttonElement.innerHTML = '<div class="spinner w-5 h-5 mx-auto"></div>'; 

            try {
                const { error } = await _supabase.from('friend_requests').insert({
                    sender_id: currentAuthUser.id,
                    receiver_id: targetAuthId,
                    status: 'pending' 
                });

                if (error) {
                    if (error.code === '23505') { 
                        showToast("Friend request already sent.", 'success');
                         buttonElement.innerHTML = '<i data-feather="check" class="w-5 h-5"></i>';
                         buttonElement.title = "Request Sent";
                         buttonElement.classList.replace('bg-primary-100', 'bg-gray-200');
                         buttonElement.classList.replace('text-primary-600', 'text-gray-500');
                         buttonElement.classList.add('cursor-not-allowed');
                         feather.replace();
                    } else {
                        throw error;
                    }
                } else {
                    showToast("Friend request sent!", 'success');
                    buttonElement.innerHTML = '<i data-feather="check" class="w-5 h-5"></i>';
                    buttonElement.title = "Request Sent";
                    buttonElement.classList.replace('bg-primary-100', 'bg-gray-200');
                    buttonElement.classList.replace('text-primary-600', 'text-gray-500');
                    buttonElement.classList.add('cursor-not-allowed');
                    feather.replace();
                }

            } catch (error) {
                console.error("Error sending friend request:", error);
                showToast("Could not send friend request.", 'error');
                buttonElement.innerHTML = '<i data-feather="user-plus" class="w-5 h-5"></i>';
                buttonElement.disabled = false;
                feather.replace();
            }
        }

        // --- Toast Notification ---
        // (This function remains unchanged)
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const iconName = type === 'success' ? 'check-circle' : 'alert-circle';
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i data-feather="${iconName}" class="toast-icon"></i>
                <span class="font-medium">${message}</span>
            `;
            toastContainer.appendChild(toast);
            feather.replace(); 
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 3000);
        }

    </script>

</body>
</html>
