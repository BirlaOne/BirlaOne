<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - BirlaOne</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {font-family: 'Inter', sans-serif; padding:20px; background:#fafafa;}
    .profile {background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:400px; margin:auto;}
    img {border-radius:50%; width:80px; height:80px; object-fit:cover;}
    h2 {margin:10px 0;}
  </style>
</head>
<body>

  <div class="profile" id="profileBox">
    <p>Loading profile...</p>
  </div>

<script>
const SUPABASE_URL = "https://eikriuddsuguybvvyzjl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpa3JpdWRkc3VndXlidnZ5empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjIxNTAsImV4cCI6MjA3MzY5ODE1MH0.HNh2gGO8nWzAjxh5Oa3cs_8WKaq9mq9TyLCvPOkcr2c";  // replace with your key
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
}

async function loadProfile() {
  const { data: { session } } = await supabase.auth.getSession();

  let profile = null;

  if (session?.user) {
    // Preferred: fetch via auth_id
    const { data, error } = await supabase
      .from("users")
      .select("id, name, email, mob, img, role")
      .eq("auth_id", session.user.id)
      .single();

    if (!error && data) profile = data;
  }

  if (!profile) {
    // Fallback: use student ID cookie
    const studentId = getCookie("id");
    if (studentId) {
      const { data, error } = await supabase
        .from("users")
        .select("id, name, email, mob, img, role")
        .eq("id", parseInt(studentId, 10))
        .single();

      if (!error && data) profile = data;
    }
  }

  if (!profile) {
    window.location.href = "login.html";
    return;
  }

  document.getElementById("profileBox").innerHTML = `
    <img src="${profile.img || "https://via.placeholder.com/80"}" alt="Profile">
    <h2>${profile.name}</h2>
    <p><b>ID:</b> ${profile.id}</p>
    <p><b>Email:</b> ${profile.email}</p>
    <p><b>Mobile:</b> ${profile.mob}</p>
    <p><b>Role:</b> ${profile.role}</p>
    <button onclick="logout()">Logout</button>
  `;
}

async function logout() {
  await supabase.auth.signOut();
  document.cookie = "id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
  window.location.href = "login.html";
}

loadProfile();
</script>

</body>
</html>
