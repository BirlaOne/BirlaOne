<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Debug Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Debug Dashboard</h1>
  <pre id="output">Loading...</pre>

<script>
const SUPABASE_URL = "https://eikriuddsuguybvvyzjl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpa3JpdWRkc3VndXlidnZ5empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjIxNTAsImV4cCI6MjA3MzY5ODE1MH0.HNh2gGO8nWzAjxh5Oa3cs_8WKaq9mq9TyLCvPOkcr2c";  // replace
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
}

async function loadProfile() {
  const out = document.getElementById("output");

  console.log("🔎 Checking session...");
  const { data: { session }, error: sessErr } = await supabase.auth.getSession();
  console.log("Session:", session, sessErr);

  let profile = null;

  if (session?.user) {
    console.log("✅ Found session. Trying auth_id lookup:", session.user.id);
    const { data, error } = await supabase
      .from("users")
      .select("id, name, email, mob, role, auth_id")
      .eq("auth_id", session.user.id)
      .single();
    console.log("Auth_id query result:", data, error);
    if (!error && data) profile = data;
  }

  if (!profile) {
    const studentId = getCookie("id");
    console.log("⚠️ Auth_id fetch failed. Cookie studentId:", studentId);
    if (studentId) {
      const { data, error } = await supabase
        .from("users")
        .select("id, name, email, mob, role, auth_id")
        .eq("id", parseInt(studentId, 10))
        .single();
      console.log("Cookie query result:", data, error);
      if (!error && data) profile = data;
    }
  }

  if (!profile) {
    out.textContent = "❌ No profile found. Redirecting to login in 10s...\nCheck console logs!";
    console.log("❌ No profile found. Redirecting in 10s...");
    setTimeout(() => window.location.href = "login.html", 10000); // wait 10s
    return;
  }

  out.textContent = "✅ Profile loaded:\n\n" + JSON.stringify(profile, null, 2);
  console.log("✅ Profile loaded:", profile);
}
loadProfile();
</script>
</body>
</html>
