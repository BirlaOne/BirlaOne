<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirlaOne Post</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Feather Icons Script -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Supabase Client v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': {
                            '50': '#f7fbf4','100': '#eef8e9','200': '#dcf1d3','300': '#c3e7b3',
                            '400': '#a6d98e','500': '#87c964','600': '#56ab2f','700': '#458a26',
                            '800': '#396f21','900': '#305b1c','950': '#1a320f',
                        },
                    }
                },
            },
        };
    </script>
    
    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .top-nav-shadow { box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.03); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        i[data-feather], svg.feather { width: 24px; height: 24px; stroke: currentColor; }
        .liked svg.feather-heart, .liked i[data-feather="heart"] { fill: #ef4444; color: #ef4444; stroke: #ef4444; }
        .engagement-icon { width: 20px; height: 20px; }
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: #56ab2f; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .poll-option-button { min-height: 44px; }
        .poll-bar-fg { height: 100%; transition: width 0.3s ease-in-out; }
        .delete-comment-button svg.feather { width: 16px; height: 16px; } 
    </style>
</head>
<body class="antialiased">

    <!-- App Container -->
    <div class="relative min-h-screen w-full md:max-w-md md:mx-auto md:shadow-2xl md:overflow-hidden bg-slate-50">

        <!-- Top Navigation -->
        <header class="fixed top-0 left-0 right-0 z-40 bg-white/95 backdrop-blur-sm top-nav-shadow p-4 flex justify-between items-center md:max-w-md md:mx-auto h-16">
            <!-- Back Button -->
            <a href="feed.html" class="p-2 rounded-full transition-all hover:bg-gray-100 active:scale-90">
                <i data-feather="arrow-left" class="text-gray-700"></i>
            </a>
            <h1 class="text-xl font-semibold text-gray-900">Post Details</h1>
            <!-- Placeholder -->
            <div class="w-10 h-10"></div> 
        </header>

        <!-- Main Content - Single Post -->
        <main class="pt-20 pb-10 p-4 space-y-6 overflow-y-auto h-screen no-scrollbar">
            
            <!-- Post Container -->
            <div id="post-container" class="space-y-6">
                <div id="post-loading" class="text-center py-10 text-gray-500">
                    <p>Loading post...</p>
                </div>
                <!-- Post will be injected here -->
            </div>

            <!-- Login Prompt (Initially Hidden) -->
            <div id="login-prompt" class="hidden text-center p-6 bg-white rounded-2xl border border-gray-200 shadow-sm mt-6">
                 <h3 class="font-semibold text-lg text-gray-800 mb-3">Join the Conversation!</h3>
                 <p class="text-gray-600 mb-4">Log in or sign up to like, comment, and vote.</p>
                 <a href="login.html" class="inline-block bg-primary-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-primary-700 transition-colors">
                     Login / Sign Up
                 </a>
            </div>

             <!-- Comments Section (Wrapper) -->
             <div id="comments-section-wrapper" class="hidden space-y-3 bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mt-6">
                 <h2 class="text-xl font-bold text-gray-900">Comments</h2>
                 <div id="comments-list" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                     <p id="comments-loading" class="text-sm text-gray-500">Loading comments...</p>
                     <!-- Comments will load here -->
                 </div>
                 <!-- Comment Input (shown only if logged in) -->
                 <div id="comment-input-area" class="hidden flex items-center space-x-2 pt-3 border-t border-gray-100">
                     <img id="commenter-avatar" src="https://placehold.co/32x32/A8E063/305B1C?text=U" alt="You" class="w-8 h-8 rounded-full bg-gray-200">
                     <input type="text" id="comment-input" placeholder="Write a comment..." class="flex-1 bg-gray-100 rounded-full py-2 px-4 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600">
                     <button id="comment-submit-button" class="p-2 text-primary-600 hover:bg-primary-50 rounded-full">
                         <i data-feather="send" class="w-5 h-5"></i>
                     </button>
                 </div>
             </div>


        </main>
        <!-- No Bottom Nav Here -->
    </div>

    <!-- ===== Supabase & App Logic ===== -->
    <script>
        // --- 1. SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://eikriuddsuguybvvyzjl.supabase.co'; // REPLACE WITH YOUR URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpa3JpdWRkc3VndXlidnZ5empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjIxNTAsImV4cCI6MjA3MzY5ODE1MH0.HNh2gGO8nWzAjxh5Oa3cs_8WKaq9mq9TyLCvPOkcr2c'; // REPLACE WITH YOUR ANON KEY
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global variables ---
        let currentAuthUser = null;
        let currentUserProfile = null; 
        let currentPostId = null; 
        const postContainer = document.getElementById('post-container');
        const postLoading = document.getElementById('post-loading');
        const loginPrompt = document.getElementById('login-prompt');
        const commentInputArea = document.getElementById('comment-input-area');
        const commentsWrapper = document.getElementById('comments-section-wrapper'); // Get wrapper
        const commentsList = document.getElementById('comments-list');
        const commentsLoading = document.getElementById('comments-loading');
        const commenterAvatar = document.getElementById('commenter-avatar');


        // --- 2. GET POST ID & INITIALIZE ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentPostId = urlParams.get('id');

            if (!currentPostId) {
                postLoading.innerHTML = `<p class="text-red-500 font-semibold text-center">Error: Post ID not found in URL.</p>`;
                commentsWrapper.classList.add('hidden'); // Hide comments if no post ID
                return;
            }

            const { data: { session }, error: sessionError } = await _supabase.auth.getSession();
            if (sessionError) { console.error("Session Error:", sessionError); } 
            
            if (session) {
                currentAuthUser = session.user;
                await fetchUserProfile(currentAuthUser.id); 
                commentInputArea.classList.remove('hidden'); 
            } else {
                 loginPrompt.classList.remove('hidden'); 
            }

            await fetchAndRenderPost(currentPostId); // Fetch post (publicly readable)
           
            // Fetch comments ONLY if user is logged in (based on RLS)
            if (currentAuthUser) {
                 commentsWrapper.classList.remove('hidden'); // Show comments section
                 await fetchAndRenderComments(currentPostId); 
            } else {
                 commentsWrapper.classList.add('hidden'); // Ensure comments section is hidden if logged out
            }

            feather.replace(); 
            setupEventListeners(); 
            // Realtime listeners could be added here if needed for single post view
        });

        // --- 3. FETCH USER PROFILE ---
         async function fetchUserProfile(authId) { 
             if (!authId) return; 
             const { data, error } = await _supabase.from('users').select('name, img').eq('auth_id', authId).single(); 
             if (error) { console.error("Error fetching user profile:", error.message); } 
             else if (data) { 
                 currentUserProfile = data; 
                 const userAvatar = data.img || `https://placehold.co/32x32/A8E063/305B1C?text=${data.name ? data.name.charAt(0) : 'U'}`; 
                 if(commenterAvatar) commenterAvatar.src = userAvatar; 
             }
         }

        // --- 4. FETCH & RENDER SINGLE POST ---
        async function fetchAndRenderPost(postId) {
            postLoading.style.display = 'block';
            try {
                let query = _supabase
                    .from('posts')
                    .select(` id, content, post_type, media_url, poll_options, is_anonymous, created_at, like_count, comment_count, users:user_id (name, img) `)
                    .eq('id', postId);

                // If logged in, ALSO fetch like and vote status for *this user*
                if (currentAuthUser) {
                    query = query.select(` *, users:user_id (name, img), likes!left (user_id), poll_votes!left (user_id, selected_option_index) `)
                    .eq('likes.user_id', currentAuthUser.id) 
                    .eq('poll_votes.user_id', currentAuthUser.id);
                }
                 
                const { data: post, error } = await query.single(); 

                if (error) { if (error.code === 'PGRST116') { throw new Error("Post not found."); } throw error; }
                if (!post) { throw new Error("Post not found."); }

                const processedPost = {
                    ...post,
                    currentUserLiked: currentAuthUser ? (post.likes?.length > 0) : false, 
                    currentUserPollVote: currentAuthUser ? (post.poll_votes?.length > 0 ? post.poll_votes[0].selected_option_index : null) : null
                };
                renderSinglePost(processedPost);
            } catch (error) {
                console.error("Error fetching post:", error.message);
                postLoading.style.display = 'none';
                postContainer.innerHTML = `<p class="text-center text-red-500 font-semibold">${error.message}</p>`;
                commentsWrapper.classList.add('hidden'); // Hide comments if post fails to load
            }
        }

        function renderSinglePost(post) {
            postLoading.style.display = 'none';
            const postHtml = createPostHTML(post); 
            postContainer.innerHTML = postHtml;
            feather.replace(); // Render icons within the post
        }


        // --- 5. SETUP EVENT LISTENERS ---
        function setupEventListeners() { 
             postContainer.addEventListener('click', (event) => {
                 const likeButton = event.target.closest('.like-button'); 
                 if (likeButton) { 
                     if (!currentAuthUser) { loginPrompt.classList.remove('hidden'); scrollToLoginPrompt(); return; } 
                     toggleLike(likeButton.dataset.postId, likeButton.dataset.liked === 'true', likeButton); return; 
                 }
                 const pollOptionButton = event.target.closest('.poll-option-button'); 
                 if (pollOptionButton) { 
                      if (!currentAuthUser) { loginPrompt.classList.remove('hidden'); scrollToLoginPrompt(); return; } 
                      handlePollVote(pollOptionButton.dataset.postId, parseInt(pollOptionButton.dataset.optionIndex), pollOptionButton.closest('.poll-options-container'), pollOptionButton); return; 
                 }
                 // Comment toggle button removed from single post view
                 const shareButton = event.target.closest('.share-button'); 
                 if (shareButton) { handleShare(shareButton.dataset.postId); return; } 
             });

            // Specific listener for comment submission (only works if element is visible)
             const submitButton = document.getElementById('comment-submit-button');
             if(submitButton) {
                 submitButton.addEventListener('click', () => {
                     // No need to check currentAuthUser here as the input area is hidden if not logged in
                     handleCommentSubmit(currentPostId); 
                 });
             }

            // Specific listener for comment deletion (only works if element is visible)
             commentsList.addEventListener('click', (event) => {
                 const deleteButton = event.target.closest('.delete-comment-button');
                 if (deleteButton) {
                      // No need to check currentAuthUser here as button isn't rendered if not logged in/owner
                      handleDeleteComment(deleteButton.dataset.commentId, deleteButton.dataset.postId, deleteButton);
                 }
             });
        }

        // --- 6. CREATE POST HTML (Handles logged-out state for interactions) ---
        function createPostHTML(post) { 
            const authorName = post.is_anonymous ? 'Campus Confession' : (post.users?.name || 'Unknown User'); 
            const authorAvatar = post.is_anonymous ? `<div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center"><i data-feather="eye-off" class="text-white w-5 h-5"></i></div>` : `<img src="${post.users?.img || `https://placehold.co/40x40/DCEFD3/305B1C?text=${authorName.charAt(0)}`}" alt="Profile" class="w-10 h-10 rounded-full bg-gray-200">`; 
            const postTimestamp = formatTimeAgo(post.created_at); 
            const isLiked = post.currentUserLiked; 
            const likeClass = isLiked ? 'liked text-red-500' : 'text-gray-600'; 
            const userVotedIndex = post.currentUserPollVote; 
            let postBody = ''; 
            
            switch(post.post_type) { 
                case 'photo': postBody = ` ${post.content ? `<p class="px-4 pb-3 text-gray-800">${post.content}</p>` : ''} <img src="${post.media_url}" alt="Post media" class="w-full object-cover bg-gray-100 min-h-[200px]"> `; break; 
                case 'poll': 
                    const pollOptionsHtml = (post.poll_options || []).map((option, index) => { 
                        const isDisabled = !currentAuthUser; // Disabled if not logged in
                        const baseClasses = 'border hover:bg-gray-100 cursor-pointer';
                        const selectedClasses = 'border border-gray-300'; // Default
                        return ` <button class="poll-option-button w-full text-left rounded-xl p-3 font-medium text-gray-900 relative transition-colors ${selectedClasses} ${isDisabled ? 'opacity-70 !cursor-not-allowed !hover:bg-transparent' : baseClasses}" data-post-id="${post.id}" data-option-index="${index}" ${isDisabled ? 'disabled' : ''} > <div class="absolute inset-0 bg-primary-300/50 rounded-lg poll-bar-fg" style="width: 0%;"></div> <span class="relative z-10">${option.option} (0%)</span> </button> `; }).join(''); 
                    postBody = ` <p class="px-4 pb-3 font-semibold text-lg text-gray-900">${post.content}</p> <div class="px-4 pb-4 space-y-3 poll-options-container" data-post-id="${post.id}">${pollOptionsHtml}</div> `; 
                    // Load results regardless of login status (styling handles visual difference)
                    setTimeout(() => { const container = document.querySelector(`.poll-options-container[data-post-id="${post.id}"]`); if(container) updatePollUI(post.id, container, userVotedIndex); }, 0); 
                    break; 
                case 'text': 
                case 'anonymous': 
                default: postBody = `<p class="px-4 pb-4 text-gray-800 text-base">${post.content}</p>`; 
            } 
            
            const headerClass = post.is_anonymous ? 'bg-gray-800' : 'bg-white'; 
            const headerText = post.is_anonymous ? 'text-white' : 'text-gray-900'; 
            const subText = post.is_anonymous ? 'text-gray-400' : 'text-gray-500'; 
            
            // Like Button: Interactive only if logged in
            const likeButtonHtml = currentAuthUser 
                 ? `<button class="like-button flex-1 flex justify-center items-center space-x-2 p-3 hover:bg-red-50 transition-colors ${likeClass}" data-post-id="${post.id}" data-liked="${isLiked}"> <i data-feather="heart" class="engagement-icon ${isLiked ? 'fill-current' : ''}"></i> <span class="like-count text-sm font-medium">${post.like_count}</span> </button>`
                 : `<div class="flex-1 flex justify-center items-center space-x-2 p-3 text-gray-500"> <i data-feather="heart" class="engagement-icon"></i> <span class="like-count text-sm font-medium">${post.like_count}</span> </div>`;

             // Comment Button: Always shows count, but interaction handled separately
             const commentButtonHtml = `<div class="flex-1 flex justify-center items-center space-x-2 p-3 text-gray-600"> <i data-feather="message-square" class="engagement-icon"></i> <span class="comment-count text-sm font-medium">${post.comment_count}</span> </div>`;
            
             const shareButtonHtml = `<button class="share-button flex-1 flex justify-center items-center space-x-2 p-3 text-gray-600 hover:bg-gray-50 hover:text-primary-600 transition-colors" data-post-id="${post.id}"> <i data-feather="share-2" class="engagement-icon"></i> <span class="text-sm font-medium">Share</span> </button>`;

            return ` 
                 <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden" id="post-${post.id}"> 
                     <div class="flex items-center space-x-3 p-4 ${headerClass}"> ${authorAvatar} <div> <p class="font-semibold ${headerText}">${authorName}</p> <p class="text-xs ${subText}">${postTimestamp}</p> </div> </div> 
                     ${postBody} 
                     <div class="flex justify-around border-t border-gray-100"> 
                         ${likeButtonHtml}
                         ${commentButtonHtml} 
                         ${shareButtonHtml}
                     </div> 
                 </div> 
            `;
        }


        // --- 7. LIKE/UNLIKE LOGIC ---
        async function toggleLike(postId, isLiked, buttonElement) { /* ... (same as before) ... */ }

        // --- 8. HELPER: Time Ago ---
        function formatTimeAgo(dateString) { /* ... (same as before) ... */ }

        // --- 9. POLL VOTE LOGIC ---
        async function handlePollVote(postId, optionIndex, optionsContainer, clickedButton) { /* ... (same as before) ... */ }

        // --- 10. LOAD & UPDATE POLL RESULTS ---
        async function loadPollResults(postId) { /* ... (same as before) ... */ }
        async function updatePollUI(postId, optionsContainer, userVotedIndex = null) { /* ... (modified to disable/style based on currentAuthUser) ... */ }

        // --- 11. COMMENTS LOGIC ---
        async function fetchAndRenderComments(postId) { /* ... (same as before, fetches comments) ... */ }
        function renderComments(postId, comments) { /* ... (same as before, renders comments with delete button if owner) ... */ }
        async function handleCommentSubmit(postId) { /* ... (same as before, submits comment) ... */ }
        async function handleDeleteComment(commentId, postId, buttonElement) { /* ... (same as before, deletes comment) ... */ }


        // --- 12. SHARE LOGIC ---
        async function handleShare(postId) { /* ... (same as before, uses Web Share API or fallback) ... */ }

        // --- 13. CLIPBOARD HELPER ---
        function fallbackCopyToClipboard(text) { /* ... (same as before) ... */ }
        function copyToClipboard(text) { /* ... (same as before) ... */ }

        // --- Helper to scroll to login prompt ---
        function scrollToLoginPrompt() {
             loginPrompt.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // --- Realtime functions (like/poll/comment updates) omitted for simplicity ---
        // --- Add them back if needed for single post view ---

    </script>
    
    <!-- Include the full implementations of functions omitted above -->
    <script>
        // Paste the full implementations of these functions here from the previous feed.html:
        // toggleLike(postId, isLiked, buttonElement)
        // formatTimeAgo(dateString)
        // handlePollVote(postId, optionIndex, optionsContainer, clickedButton)
        // loadPollResults(postId) 
        // updatePollUI(postId, optionsContainer, userVotedIndex = null) // Make sure it uses currentAuthUser check for disabling
        // toggleCommentsSection(postId) // Not used directly, but fetch/render are needed
        // fetchAndRenderComments(postId) // Renamed from toggleCommentsSection's fetch part
        // renderComments(postId, comments)
        // handleCommentSubmit(postId)
        // handleDeleteComment(commentId, postId, buttonElement)
        // handleShare(postId)
        // fallbackCopyToClipboard(text)
        // copyToClipboard(text)

        // Make sure to copy the exact, up-to-date functions we developed for feed.html
        // Example (updatePollUI needs the currentAuthUser check):
         async function updatePollUI(postId, optionsContainer, userVotedIndex = null) { 
            if (!optionsContainer) return; 
            try { 
                const { data: votes, error: countError } = await _supabase.from('poll_votes').select('selected_option_index, user_id').eq('post_id', postId); 
                if (countError) throw countError; 
                const totalVotes = votes.length; 
                const voteCounts = {}; 
                let currentUserActualVoteIndex = null; 
                votes.forEach(vote => { voteCounts[vote.selected_option_index] = (voteCounts[vote.selected_option_index] || 0) + 1; if(vote.user_id === currentAuthUser?.id) { currentUserActualVoteIndex = vote.selected_option_index; } }); 
                currentUserActualVoteIndex = currentUserActualVoteIndex ?? userVotedIndex; 

                optionsContainer.querySelectorAll('.poll-option-button').forEach(button => { 
                    const idx = parseInt(button.dataset.optionIndex); 
                    const votesForOption = voteCounts[idx] || 0; 
                    const percentage = totalVotes > 0 ? Math.round((votesForOption / totalVotes) * 100) : 0; 
                    button.querySelector('.poll-bar-fg').style.width = `${percentage}%`; 
                    const originalOptionText = button.querySelector('.relative.z-10').textContent.split('(')[0].trim(); 
                    button.querySelector('.relative.z-10').textContent = `${originalOptionText} (${percentage}%)`; 
                    const isSelectedByCurrentUser = currentUserActualVoteIndex === idx; 

                    // --- Modification ---
                    // Disable ONLY if user is logged out OR if results are being shown (i.e., someone has voted)
                    button.disabled = !currentAuthUser; // || totalVotes > 0 || userVotedIndex !== null; 
                    button.classList.toggle('hover:bg-gray-100', !!currentAuthUser); 
                    button.classList.toggle('cursor-pointer', !!currentAuthUser); 
                    button.classList.toggle('opacity-70', !currentAuthUser); 
                    button.classList.toggle('!cursor-not-allowed', !currentAuthUser); 
                    // --- End Modification ---

                    button.classList.toggle('border-2', isSelectedByCurrentUser); 
                    button.classList.toggle('border-primary-600', isSelectedByCurrentUser); 
                    button.classList.toggle('bg-primary-100', isSelectedByCurrentUser); 
                    button.classList.toggle('border', !isSelectedByCurrentUser); 
                    button.classList.toggle('border-gray-300', !isSelectedByCurrentUser); 
                }); 
            } catch (error) { console.error(`Error updating poll UI for post ${postId}:`, error.message); }
         }

         // Add the rest of the function implementations here...

    </script>


</body>
</html>
