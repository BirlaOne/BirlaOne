<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirlaOne Post</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': { // Green Theme
                            '50': '#f7fbf4','100': '#eef8e9','200': '#dcf1d3','300': '#c3e7b3',
                            '400': '#a6d98e','500': '#87c964','600': '#56ab2f','700': '#458a26',
                            '800': '#396f21','900': '#305b1c','950': '#1a320f',
                        },
                    }
                },
            },
        };
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; /* bg-slate-50 */ }
        .top-nav-shadow { box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.03); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        i[data-feather], svg.feather { width: 24px; height: 24px; stroke: currentColor; }
        .liked svg.feather-heart, .liked i[data-feather="heart"] { fill: #ef4444; color: #ef4444; stroke: #ef4444; }
        .engagement-icon { width: 20px; height: 20px; }
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: #56ab2f; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .poll-option-button { min-height: 44px; }
        .poll-bar-fg { height: 100%; transition: width 0.3s ease-in-out; }
        .delete-comment-button svg.feather { width: 16px; height: 16px; } 
    </style>
</head>
<body class="antialiased">

    <div class="relative min-h-screen w-full md:max-w-md md:mx-auto md:shadow-2xl md:overflow-hidden bg-slate-50">

        <header class="fixed top-0 left-0 right-0 z-40 bg-white/95 backdrop-blur-sm top-nav-shadow p-4 flex justify-between items-center md:max-w-md md:mx-auto h-16">
            <a href="feed.html" class="p-2 rounded-full transition-all hover:bg-gray-100 active:scale-90">
                <i data-feather="arrow-left" class="text-gray-700"></i>
            </a>
            <h1 class="text-xl font-semibold text-gray-900">Post Details</h1>
            <div class="w-10 h-10"></div> 
        </header>

        <main class="pt-20 pb-10 p-4 space-y-6 overflow-y-auto h-screen no-scrollbar">
            
            <div id="post-container" class="space-y-6">
                <div id="post-loading" class="text-center py-10 text-gray-500">
                    <p>Loading post...</p>
                </div>
                </div>

            <div id="login-prompt" class="hidden text-center p-6 bg-white rounded-2xl border border-gray-200 shadow-sm mt-6">
                 <h3 class="font-semibold text-lg text-gray-800 mb-3">Join the Conversation!</h3>
                 <p class="text-gray-600 mb-4">Log in or sign up to like, comment, and vote.</p>
                 <a href="login.html" class="inline-block bg-primary-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-primary-700 transition-colors">
                     Login / Sign Up
                 </a>
            </div>

             <div id="comments-section-wrapper" class="hidden space-y-3 bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mt-6">
                 <h2 class="text-xl font-bold text-gray-900">Comments</h2>
                 <div id="comments-list" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                     <p id="comments-loading" class="text-sm text-gray-500">Loading comments...</p>
                     </div>
                 <div id="comment-input-area" class="hidden flex items-center space-x-2 pt-3 border-t border-gray-100">
                     <img id="commenter-avatar" src="https://placehold.co/32x32/A8E063/305B1C?text=U" alt="You" class="w-8 h-8 rounded-full bg-gray-200">
                     <input type="text" id="comment-input" placeholder="Write a comment..." class="flex-1 bg-gray-100 rounded-full py-2 px-4 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600">
                     <button id="comment-submit-button" class="p-2 text-primary-600 hover:bg-primary-50 rounded-full">
                         <i data-feather="send" class="w-5 h-5"></i>
                     </button>
                 </div>
             </div>


        </main>
        </div>

    <script>
        // --- 1. SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://eikriuddsuguybvvyzjl.supabase.co'; // REPLACE WITH YOUR URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpa3JpdWRkc3VndXlidnZ5empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjIxNTAsImV4cCI6MjA3MzY5ODE1MH0.HNh2gGO8nWzAjxh5Oa3cs_8WKaq9mq9TyLCvPOkcr2c'; // REPLACE WITH YOUR ANON KEY
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global variables ---
        let currentAuthUser = null;
        let currentUserProfile = null; 
        let currentPostId = null; 
        const postContainer = document.getElementById('post-container');
        const postLoading = document.getElementById('post-loading');
        const loginPrompt = document.getElementById('login-prompt');
        const commentInputArea = document.getElementById('comment-input-area');
        const commentsWrapper = document.getElementById('comments-section-wrapper'); 
        const commentsList = document.getElementById('comments-list');
        const commentsLoading = document.getElementById('comments-loading');
        const commenterAvatar = document.getElementById('commenter-avatar');


        // --- 2. GET POST ID & INITIALIZE ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentPostId = urlParams.get('id');

            if (!currentPostId) {
                postLoading.innerHTML = `<p class="text-red-500 font-semibold text-center">Error: Post ID not found in URL.</p>`;
                commentsWrapper.classList.add('hidden'); 
                return;
            }

            const { data: { session }, error: sessionError } = await _supabase.auth.getSession();
            if (sessionError) { console.error("Session Error:", sessionError); } 
            
            if (session) {
                currentAuthUser = session.user;
                await fetchUserProfile(currentAuthUser.id); 
                commentInputArea.classList.remove('hidden'); 
            } else {
                 loginPrompt.classList.remove('hidden'); 
            }

            await fetchAndRenderPost(currentPostId); 
           
            // Fetch comments if RLS allows (either logged in, or if comments were made public)
             commentsWrapper.classList.remove('hidden'); // Show wrapper, loading text is inside
             await fetchAndRenderComments(currentPostId); 

            feather.replace(); 
            setupEventListeners(); 
            // Realtime subscriptions omitted for single post page simplicity
        });

        // --- 3. FETCH USER PROFILE ---
         async function fetchUserProfile(authId) { 
             if (!authId) return; 
             const { data, error } = await _supabase.from('users').select('name, img').eq('auth_id', authId).single(); 
             if (error) { console.error("Error fetching user profile:", error.message); } 
             else if (data) { 
                 currentUserProfile = data; 
                 const userAvatar = data.img || `https://placehold.co/32x32/A8E063/305B1C?text=${data.name ? data.name.charAt(0) : 'U'}`; 
                 if(commenterAvatar) commenterAvatar.src = userAvatar; 
             }
         }


        // --- 4. FETCH & RENDER SINGLE POST ---
        async function fetchAndRenderPost(postId) {
            postLoading.style.display = 'block';
            try {
                let query = _supabase
                    .from('posts')
                    .select(` id, content, post_type, media_url, poll_options, is_anonymous, created_at, like_count, comment_count, users:user_id (name, img) `)
                    .eq('id', postId);

                if (currentAuthUser) {
                    query = query.select(` *, users:user_id (name, img), likes!left (user_id), poll_votes!left (user_id, selected_option_index) `)
                    .eq('likes.user_id', currentAuthUser.id) 
                    .eq('poll_votes.user_id', currentAuthUser.id);
                }
                 
                const { data: post, error } = await query.single(); 

                if (error) { if (error.code === 'PGRST116') { throw new Error("Post not found."); } throw error; }
                if (!post) { throw new Error("Post not found."); }

                const processedPost = {
                    ...post,
                    currentUserLiked: currentAuthUser ? (post.likes?.length > 0) : false, 
                    currentUserPollVote: currentAuthUser ? (post.poll_votes?.length > 0 ? post.poll_votes[0].selected_option_index : null) : null
                };
                renderSinglePost(processedPost);
            } catch (error) {
                console.error("Error fetching post:", error.message);
                postLoading.style.display = 'none';
                postContainer.innerHTML = `<p class="text-center text-red-500 font-semibold">${error.message}</p>`;
                commentsWrapper.classList.add('hidden'); 
            }
        }

        function renderSinglePost(post) {
            postLoading.style.display = 'none';
            const postHtml = createPostHTML(post); 
            postContainer.innerHTML = postHtml;
            feather.replace(); 
        }


        // --- 5. SETUP EVENT LISTENERS ---
        function setupEventListeners() { 
             postContainer.addEventListener('click', (event) => {
                 const likeButton = event.target.closest('.like-button'); 
                 if (likeButton) { 
                     if (!currentAuthUser) { loginPrompt.classList.remove('hidden'); scrollToLoginPrompt(); return; } 
                     toggleLike(likeButton.dataset.postId, likeButton.dataset.liked === 'true', likeButton); return; 
                 }
                 const pollOptionButton = event.target.closest('.poll-option-button'); 
                 if (pollOptionButton) { 
                      if (!currentAuthUser) { loginPrompt.classList.remove('hidden'); scrollToLoginPrompt(); return; } 
                      handlePollVote(pollOptionButton.dataset.postId, parseInt(pollOptionButton.dataset.optionIndex), pollOptionButton.closest('.poll-options-container'), pollOptionButton); return; 
                 }
                 // Comment toggle button removed
                 const shareButton = event.target.closest('.share-button'); 
                 if (shareButton) { handleShare(shareButton.dataset.postId); return; } 
             });

             const submitButton = document.getElementById('comment-submit-button');
             if(submitButton) {
                 submitButton.addEventListener('click', () => { handleCommentSubmit(currentPostId); });
             }

             commentsList.addEventListener('click', (event) => {
                 const deleteButton = event.target.closest('.delete-comment-button');
                 if (deleteButton) { handleDeleteComment(deleteButton.dataset.commentId, deleteButton.dataset.postId, deleteButton); }
             });
        }

        // --- 6. CREATE POST HTML ---
        function createPostHTML(post) { 
            const authorName = post.is_anonymous ? 'Campus Confession' : (post.users?.name || 'Unknown User'); 
            const authorAvatar = post.is_anonymous ? `<div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center"><i data-feather="eye-off" class="text-white w-5 h-5"></i></div>` : `<img src="${post.users?.img || `https://placehold.co/40x40/DCEFD3/305B1C?text=${authorName.charAt(0)}`}" alt="Profile" class="w-10 h-10 rounded-full bg-gray-200">`; 
            const postTimestamp = formatTimeAgo(post.created_at); 
            const isLiked = post.currentUserLiked; 
            const likeClass = isLiked ? 'liked text-red-500' : 'text-gray-600'; 
            const userVotedIndex = post.currentUserPollVote; 
            let postBody = ''; 
            
            switch(post.post_type) { 
                case 'photo': postBody = ` ${post.content ? `<p class="px-4 pb-3 text-gray-800">${post.content}</p>` : ''} <img src="${post.media_url}" alt="Post media" class="w-full object-cover bg-gray-100 min-h-[200px]"> `; break; 
                case 'poll': 
                    const pollOptionsHtml = (post.poll_options || []).map((option, index) => { 
                        const isDisabled = !currentAuthUser; 
                        const baseClasses = 'border hover:bg-gray-100 cursor-pointer';
                        const selectedClasses = 'border border-gray-300'; 
                        return ` <button class="poll-option-button w-full text-left rounded-xl p-3 font-medium text-gray-900 relative transition-colors ${selectedClasses} ${isDisabled ? 'opacity-70 !cursor-not-allowed !hover:bg-transparent' : baseClasses}" data-post-id="${post.id}" data-option-index="${index}" ${isDisabled ? 'disabled' : ''} > <div class="absolute inset-0 bg-primary-300/50 rounded-lg poll-bar-fg" style="width: 0%;"></div> <span class="relative z-10">${option.option} (0%)</span> </button> `; }).join(''); 
                    postBody = ` <p class="px-4 pb-3 font-semibold text-lg text-gray-900">${post.content}</p> <div class="px-4 pb-4 space-y-3 poll-options-container" data-post-id="${post.id}">${pollOptionsHtml}</div> `; 
                    setTimeout(() => { const container = document.querySelector(`.poll-options-container[data-post-id="${post.id}"]`); if(container) updatePollUI(post.id, container, userVotedIndex); }, 0); 
                    break; 
                case 'text': 
                case 'anonymous': 
                default: postBody = `<p class="px-4 pb-4 text-gray-800 text-base">${post.content}</p>`; 
            } 
            
            const headerClass = post.is_anonymous ? 'bg-gray-800' : 'bg-white'; 
            const headerText = post.is_anonymous ? 'text-white' : 'text-gray-900'; 
            const subText = post.is_anonymous ? 'text-gray-400' : 'text-gray-500'; 
            
            const likeButtonHtml = currentAuthUser 
                 ? `<button class="like-button flex-1 flex justify-center items-center space-x-2 p-3 hover:bg-red-50 transition-colors ${likeClass}" data-post-id="${post.id}" data-liked="${isLiked}"> <i data-feather="heart" class="engagement-icon ${isLiked ? 'fill-current' : ''}"></i> <span class="like-count text-sm font-medium">${post.like_count}</span> </button>`
                 : `<div class="flex-1 flex justify-center items-center space-x-2 p-3 text-gray-500"> <i data-feather="heart" class="engagement-icon"></i> <span class="like-count text-sm font-medium">${post.like_count}</span> </div>`;

             const commentButtonHtml = `<div class="flex-1 flex justify-center items-center space-x-2 p-3 text-gray-600"> <i data-feather="message-square" class="engagement-icon"></i> <span class="comment-count text-sm font-medium">${post.comment_count}</span> </div>`;
            
             const shareButtonHtml = `<button class="share-button flex-1 flex justify-center items-center space-x-2 p-3 text-gray-600 hover:bg-gray-50 hover:text-primary-600 transition-colors" data-post-id="${post.id}"> <i data-feather="share-2" class="engagement-icon"></i> <span class="text-sm font-medium">Share</span> </button>`;

            return ` 
                 <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden" id="post-${post.id}"> 
                     <div class="flex items-center space-x-3 p-4 ${headerClass}"> ${authorAvatar} <div> <p class="font-semibold ${headerText}">${authorName}</p> <p class="text-xs ${subText}">${postTimestamp}</p> </div> </div> 
                     ${postBody} 
                     <div class="flex justify-around border-t border-gray-100"> 
                         ${likeButtonHtml}
                         ${commentButtonHtml} 
                         ${shareButtonHtml}
                     </div> 
                 </div> 
            `;
        }

        // --- 7. LIKE/UNLIKE LOGIC ---
        async function toggleLike(postId, isLiked, buttonElement) { 
            if (!currentAuthUser || buttonElement.disabled) return; 
            buttonElement.disabled = true; 
            const likeIcon = buttonElement.querySelector('svg.feather-heart'); 
            const countSpan = buttonElement.querySelector('.like-count');
            let currentCount = parseInt(countSpan.textContent);
             if (isLiked) { buttonElement.dataset.liked = 'false'; buttonElement.classList.remove('liked', 'text-red-500'); buttonElement.classList.add('text-gray-600'); if (likeIcon) likeIcon.style.fill = 'none'; countSpan.textContent = Math.max(0, currentCount - 1); } 
             else { buttonElement.dataset.liked = 'true'; buttonElement.classList.add('liked', 'text-red-500'); buttonElement.classList.remove('text-gray-600'); if (likeIcon) likeIcon.style.fill = 'currentColor'; countSpan.textContent = currentCount + 1; }
            try { if (isLiked) { const { error } = await _supabase.from('likes').delete().match({ user_id: currentAuthUser.id, post_id: postId }); if (error) throw error; } 
                  else { const { error } = await _supabase.from('likes').insert({ user_id: currentAuthUser.id, post_id: postId }); if (error && error.code !== '23505') throw error; }
            } catch (error) { console.error("Error toggling like in DB:", error.message); 
                 if (isLiked) { buttonElement.dataset.liked = 'true'; buttonElement.classList.add('liked', 'text-red-500'); buttonElement.classList.remove('text-gray-600'); if (likeIcon) likeIcon.style.fill = 'currentColor'; countSpan.textContent = currentCount; } 
                 else { buttonElement.dataset.liked = 'false'; buttonElement.classList.remove('liked', 'text-red-500'); buttonElement.classList.add('text-gray-600'); if (likeIcon) likeIcon.style.fill = 'none'; countSpan.textContent = currentCount; }
            } finally { setTimeout(() => { buttonElement.disabled = false; }, 300); }
        }

        // --- 8. HELPER: Time Ago ---
        function formatTimeAgo(dateString) { 
             const date = new Date(dateString); const now = new Date(); const seconds = Math.floor((now - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "mo ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m ago"; if (seconds < 5) return "just now"; return Math.floor(seconds) + "s ago";
        }

        // --- 9. POLL VOTE LOGIC ---
        async function handlePollVote(postId, optionIndex, optionsContainer, clickedButton) { 
              if (!currentAuthUser) return; // Should be handled by listener, but double check
             const isCurrentlySelected = clickedButton.classList.contains('border-primary-600');
             let operation = 'upsert'; 
             if (isCurrentlySelected) { operation = 'delete'; }
             optionsContainer.querySelectorAll('.poll-option-button').forEach(btn => btn.disabled = true);
             try {
                 if (operation === 'delete') {
                     const { error: deleteError } = await _supabase.from('poll_votes').delete().match({ post_id: postId, user_id: currentAuthUser.id });
                     if (deleteError) throw deleteError;
                     await updatePollUI(postId, optionsContainer, null); 
                 } else {
                     const { error: upsertError } = await _supabase.from('poll_votes').upsert({ post_id: postId, user_id: currentAuthUser.id, selected_option_index: optionIndex }, { onConflict: 'post_id, user_id' });
                     if (upsertError) throw upsertError;
                     await updatePollUI(postId, optionsContainer, optionIndex); 
                 }
             } catch (error) { 
                 console.error(`Error performing poll vote ${operation}:`, error.message); alert(`Could not ${operation === 'delete' ? 'remove' : 'record'} your vote.`); 
                 await updatePollUI(postId, optionsContainer, null); 
             } 
        }

        // --- 10. LOAD & UPDATE POLL RESULTS ---
        async function loadPollResults(postId) { 
             const optionsContainer = document.querySelector(`.poll-options-container[data-post-id="${postId}"]`); if (!optionsContainer) return; try { const { data: userVote, error: userVoteError } = await _supabase.from('poll_votes').select('selected_option_index').eq('post_id', postId).eq('user_id', currentAuthUser?.id).maybeSingle(); if (userVoteError) throw userVoteError; await updatePollUI(postId, optionsContainer, userVote?.selected_option_index); } catch(error) { console.error(`Error loading poll results for post ${postId}:`, error.message); }
         }
         async function updatePollUI(postId, optionsContainer, userVotedIndex = null) { 
            if (!optionsContainer) return; 
            try { 
                const { data: votes, error: countError } = await _supabase.from('poll_votes').select('selected_option_index, user_id').eq('post_id', postId); 
                if (countError) throw countError; 
                const totalVotes = votes.length; 
                const voteCounts = {}; 
                let currentUserActualVoteIndex = null; 
                votes.forEach(vote => { voteCounts[vote.selected_option_index] = (voteCounts[vote.selected_option_index] || 0) + 1; if(vote.user_id === currentAuthUser?.id) { currentUserActualVoteIndex = vote.selected_option_index; } }); 
                currentUserActualVoteIndex = currentUserActualVoteIndex ?? userVotedIndex; 

                optionsContainer.querySelectorAll('.poll-option-button').forEach(button => { 
                    const idx = parseInt(button.dataset.optionIndex); 
                    const votesForOption = voteCounts[idx] || 0; 
                    const percentage = totalVotes > 0 ? Math.round((votesForOption / totalVotes) * 100) : 0; 
                    button.querySelector('.poll-bar-fg').style.width = `${percentage}%`; 
                    const originalOptionText = button.querySelector('.relative.z-10').textContent.split('(')[0].trim(); 
                    button.querySelector('.relative.z-10').textContent = `${originalOptionText} (${percentage}%)`; 
                    const isSelectedByCurrentUser = currentUserActualVoteIndex === idx; 

                    button.disabled = !currentAuthUser; 
                    button.classList.toggle('hover:bg-gray-100', !!currentAuthUser); 
                    button.classList.toggle('cursor-pointer', !!currentAuthUser); 
                    button.classList.toggle('opacity-70', !currentAuthUser); 
                    button.classList.toggle('!cursor-not-allowed', !currentAuthUser); 

                    button.classList.toggle('border-2', isSelectedByCurrentUser); 
                    button.classList.toggle('border-primary-600', isSelectedByCurrentUser); 
                    button.classList.toggle('bg-primary-100', isSelectedByCurrentUser); 
                    button.classList.toggle('border', !isSelectedByCurrentUser); 
                    button.classList.toggle('border-gray-300', !isSelectedByCurrentUser); 
                }); 
            } catch (error) { console.error(`Error updating poll UI for post ${postId}:`, error.message); }
         }

        // --- 11. COMMENTS LOGIC ---
        async function fetchAndRenderComments(postId) {
             commentsLoading.style.display = 'block';
             commentsList.innerHTML = ''; 
             try {
                  const { data: comments, error } = await _supabase
                     .from('comments')
                     .select(`id, content, created_at, user_id, users:user_id (name, img)`)
                     .eq('post_id', postId)
                     .is('parent_comment_id', null) 
                     .order('created_at', { ascending: true });
                 
                 if (error && error.code === '42501' && !currentAuthUser) { 
                     console.warn("User not logged in, cannot fetch comments due to RLS.");
                     commentsLoading.innerHTML = '<p class="text-sm text-gray-500 text-center">Login to view comments.</p>'; 
                     // commentsWrapper.classList.remove('hidden'); // Wrapper is already visible
                     return; 
                 } else if (error) { throw error; }

                 renderComments(postId, comments); 
                 // commentsWrapper.classList.remove('hidden'); // Wrapper is already visible

             } catch(error){
                 console.error("Error fetching comments:", error);
                 commentsLoading.style.display = 'none';
                 commentsList.innerHTML = '<p class="text-sm text-red-500">Error loading comments.</p>';
                 // commentsWrapper.classList.remove('hidden'); 
             }
        }
        function renderComments(postId, comments) { 
             commentsLoading.style.display = 'none';
             if (!commentsList) return; 
             if (comments.length === 0) { commentsList.innerHTML = '<p class="text-sm text-gray-500">No comments yet.</p>'; return; } 
             commentsList.innerHTML = comments.map(comment => { 
                 const commenterName = comment.users?.name || 'Unknown User'; 
                 const commenterAvatar = comment.users?.img || `https://placehold.co/32x32/DCEFD3/305B1C?text=${commenterName.charAt(0)}`; 
                 const commentTime = formatTimeAgo(comment.created_at); 
                 const deleteButtonHtml = (currentAuthUser && comment.user_id === currentAuthUser.id) ? `<button class="delete-comment-button ml-2 text-red-500 hover:text-red-700" data-comment-id="${comment.id}" data-post-id="${postId}" title="Delete comment"><i data-feather="trash-2" class="w-4 h-4"></i></button>` : ''; 
                 return ` <div class="comment-item flex items-start space-x-2" data-comment-id="${comment.id}"> <img src="${commenterAvatar}" alt="${commenterName}" class="w-8 h-8 rounded-full bg-gray-200 mt-1 flex-shrink-0"> <div class="flex-1 bg-gray-100 rounded-xl p-2"> <p class="font-semibold text-sm text-gray-800">${commenterName}</p> <p class="text-sm text-gray-700">${comment.content}</p> </div> <div class="flex items-center flex-shrink-0 self-center"> <span class="text-xs text-gray-400">${commentTime}</span> ${deleteButtonHtml} </div> </div> `; 
             }).join(''); 
             feather.replace(); 
         }
        async function handleCommentSubmit(postId) { 
              if (!currentAuthUser) { loginPrompt.classList.remove('hidden'); scrollToLoginPrompt(); return; } 
              const input = document.getElementById(`comment-input`); 
              const content = input.value.trim(); if (!content) return; 
              const submitButton = document.getElementById(`comment-submit-button`); 
              submitButton.disabled = true; const originalIconHTML = submitButton.innerHTML; submitButton.innerHTML = '<div class="spinner w-5 h-5 border-t-primary-600"></div>'; 
              try { 
                  const { data: newComment, error } = await _supabase.from('comments').insert({ post_id: postId, user_id: currentAuthUser.id, content: content }).select(`*, users:user_id (name, img)`).single(); 
                  if (error) throw error; 
                  if (commentsList) { 
                      const noComments = commentsList.querySelector('p'); 
                      if (noComments && commentsList.children.length <= 1) { commentsList.innerHTML = ''; } 
                      const commenterName = newComment.users?.name || 'Unknown User'; 
                      const commenterAvatar = newComment.users?.img || `https://placehold.co/32x32/DCEFD3/305B1C?text=${commenterName.charAt(0)}`; 
                      const commentTime = formatTimeAgo(newComment.created_at); 
                      const deleteButtonHtml = `<button class="delete-comment-button ml-2 text-red-500 hover:text-red-700" data-comment-id="${newComment.id}" data-post-id="${postId}" title="Delete comment"><i data-feather="trash-2" class="w-4 h-4"></i></button>`; 
                      const newCommentHtml = ` <div class="comment-item flex items-start space-x-2" data-comment-id="${newComment.id}"> <img src="${commenterAvatar}" alt="${commenterName}" class="w-8 h-8 rounded-full bg-gray-200 mt-1 flex-shrink-0"> <div class="flex-1 bg-gray-100 rounded-xl p-2"> <p class="font-semibold text-sm text-gray-800">${commenterName}</p> <p class="text-sm text-gray-700">${newComment.content}</p> </div> <div class="flex items-center flex-shrink-0 self-center"> <span class="text-xs text-gray-400">${commentTime}</span> ${deleteButtonHtml} </div> </div> `; 
                      commentsList.insertAdjacentHTML('beforeend', newCommentHtml); 
                      commentsList.scrollTop = commentsList.scrollHeight; 
                      feather.replace(); 
                  } 
                  input.value = ''; 
                  const countSpan = document.querySelector(`#post-${postId} .comment-count`); 
                  if (countSpan) { countSpan.textContent = parseInt(countSpan.textContent) + 1; } 
              } catch (error) { console.error("Error submitting comment:", error.message); alert("Could not post comment."); } 
              finally { submitButton.disabled = false; submitButton.innerHTML = originalIconHTML; const restoredIcon = submitButton.querySelector('i[data-feather="send"]'); if(restoredIcon) feather.replace({ 'data-feather': 'send'}); }
         }
        async function handleDeleteComment(commentId, postId, buttonElement) {
             if (!currentAuthUser) return;
            if (!confirm("Delete this comment?")) return; 
            buttonElement.disabled = true; const commentElement = buttonElement.closest('.comment-item'); 
            try { const { error } = await _supabase.from('comments').delete().match({ id: commentId, user_id: currentAuthUser.id }); if (error) throw error;
                 if (commentElement) { commentElement.style.opacity = '0'; commentElement.style.transition = 'opacity 0.3s ease-out'; setTimeout(() => { commentElement.remove(); if (commentsList && commentsList.children.length === 0) { commentsList.innerHTML = '<p class="text-sm text-gray-500">No comments yet.</p>'; } }, 300); }
                 const countSpan = document.querySelector(`#post-${postId} .comment-count`); if (countSpan) { countSpan.textContent = Math.max(0, parseInt(countSpan.textContent) - 1); }
            } catch (error) { console.error("Error deleting comment:", error.message); alert("Could not delete comment."); buttonElement.disabled = false; }
        }

        // --- 12. SHARE LOGIC ---
        async function handleShare(postId) { 
             const shareUrl = `${location.origin}/post.html?id=${postId}`; const postElement = document.getElementById(`post-${postId}`); let shareText = `Check out this post on BirlaOne!`; if(postElement) { const contentP = postElement.querySelector('p.text-gray-800'); if (contentP && contentP.textContent.trim().length > 0) { shareText = contentP.textContent.trim().substring(0, 100) + '...'; } } const shareData = { title: 'BirlaOne Post', text: shareText, url: shareUrl }; if (navigator.share) { try { await navigator.share(shareData); console.log('Post shared successfully'); } catch (err) { if (err.name !== 'AbortError') { console.error('Error sharing:', err); alert(`Could not share: ${err.message}`); } else { console.log('Share cancelled by user.'); } } } else { console.log('Web Share API not supported, falling back to copy.'); fallbackCopyToClipboard(shareUrl); }
        }

        // --- 13. CLIPBOARD HELPER ---
        function fallbackCopyToClipboard(text) { copyToClipboard(text).then(() => { alert("Web Share not available.\nLink copied to clipboard!"); }).catch(err => { console.error('Failed to copy link: ', err); alert("Failed to copy link."); }); }
        function copyToClipboard(text) { return new Promise((resolve, reject) => { try { const listener = (e) => { e.clipboardData.setData('text/plain', text); e.preventDefault(); }; document.addEventListener('copy', listener); document.execCommand('copy'); document.removeEventListener('copy', listener); resolve(); } catch (err) { reject(err); } }); }

        // --- Helper to scroll to login prompt ---
        function scrollToLoginPrompt() {
             loginPrompt.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
    </script>

</body>
</html>
