<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Feather Icons Script -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Supabase Client v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': { // Green Theme
                            '50': '#f7fbf4','100': '#eef8e9','200': '#dcf1d3','300': '#c3e7b3',
                            '400': '#a6d98e','500': '#87c964','600': '#56ab2f','700': '#458a26',
                            '800': '#396f21','900': '#305b1c','950': '#1a320f',
                        },
                    }
                },
            },
        };
    </script>
    
    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; /* bg-slate-50 */ }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        i[data-feather], svg.feather { width: 24px; height: 24px; stroke: currentColor; }
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: #56ab2f; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tick-mark { width: 1.5rem; height: 1.5rem; /* w-6 h-6 */ vertical-align: middle; margin-left: 4px;}
        .modal { display: none; /* Hidden by default */ }
        .modal.active { display: flex; /* Show when active */ }
        /* Disabled button style */
        button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="antialiased bg-slate-50">

    <!-- App Container -->
    <div class="relative min-h-screen w-full md:max-w-md md:mx-auto md:shadow-2xl md:overflow-hidden bg-white">

        <!-- Top Navigation (Transparent) -->
        <header class="fixed top-0 left-0 right-0 z-40 p-4 flex justify-between items-center md:max-w-md md:mx-auto">
            <a href="javascript:history.back()" class="p-2 rounded-full transition-all bg-white/50 hover:bg-white/90 active:scale-90 backdrop-blur-sm shadow-md">
                <i data-feather="arrow-left" class="text-gray-900"></i>
            </a>
            <button id="more-options-btn" class="p-2 rounded-full transition-all bg-white/50 hover:bg-white/90 active:scale-90 backdrop-blur-sm shadow-md">
                <i data-feather="more-vertical" class="text-gray-900"></i>
            </button>
        </header>

        <!-- More Options Dropdown Menu -->
        <div id="more-options-menu" class="hidden absolute top-16 right-4 z-50 w-56 bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden">
             <a href="#" id="share-profile-link" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors"> <i data-feather="share-2" class="w-5 h-5"></i> <span>Share Profile</span> </a>
             <a href="#" id="report-profile-link" class="flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 transition-colors"> <i data-feather="flag" class="w-5 h-5"></i> <span>Report Profile</span> </a>
        </div>

        <!-- Main Content - Profile -->
        <main id="main-content" class="px-6 space-y-6 pb-12 pt-16 overflow-y-auto h-screen no-scrollbar"> {/* Reduced pt */}
            
             <!-- Loading State -->
            <div id="profile-loading" class="text-center py-10 text-gray-500">
                 <div class="spinner mx-auto mb-2"></div>
                 <p>Loading profile...</p>
            </div>

            <!-- Profile Content (Hidden until loaded) -->
            <div id="profile-content" class="hidden space-y-6">

                <!-- Profile Header -->
                <div class="flex flex-col items-center">
                    <img id="profile-picture" src="https://placehold.co/100x100/A8E063/305B1C?text=?" alt="Profile Picture" class="w-24 h-24 rounded-full border-4 border-primary-600 bg-gray-200 object-cover">
                    <div class="flex items-center space-x-1.5 mt-4">
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-900">User Name</h2>
                        <img id="profile-tick" src="" alt="Verification Tick" class="tick-mark hidden">
                    </div>
                    <p id="profile-role" class="text-lg text-gray-500">Role</p>
                    <p id="profile-bio" class="text-base text-gray-700 mt-2 text-center max-w-sm"></p>
                </div>

                <!-- Stats -->
                <div class="flex justify-center items-center divide-x divide-gray-200 w-full bg-gray-50 py-4 rounded-2xl border border-gray-200">
                    <div class="flex flex-col items-center w-1/2 cursor-pointer" id="friends-count-button">
                        <span id="profile-friend-count" class="text-2xl font-bold text-gray-900">0</span>
                        <span class="text-sm text-gray-500">Friends</span>
                    </div>
                    <div class="flex flex-col items-center text-center w-1/2">
                        <span id="profile-course" class="text-2xl font-bold text-gray-900 uppercase">-</span> {/* Added uppercase */}
                        <span class="text-sm text-gray-500">Course</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center space-x-4">
                    <button id="friends-list-button" class="w-full bg-white border border-primary-600 text-primary-600 p-4 rounded-xl flex justify-center items-center space-x-2 shadow-sm transition-all duration-300 hover:bg-primary-50 active:scale-95"> <i data-feather="users" class="h-5 w-5"></i> <span class="font-semibold text-lg">Friends List</span> </button>
                    <button id="add-friend-button" class="w-full bg-gradient-to-r from-primary-600 to-primary-700 text-white p-4 rounded-xl flex justify-center items-center space-x-2 shadow-lg shadow-primary-500/30 transition-all duration-300 hover:shadow-xl hover:-translate-y-0.5 active:scale-95"> <i data-feather="user-plus" class="h-5 w-5"></i> <span class="font-semibold text-lg">Add Friend</span> </button>
                    <button id="request-sent-button" class="hidden w-full bg-gray-200 text-gray-600 p-4 rounded-xl flex justify-center items-center space-x-2 cursor-not-allowed"> <i data-feather="check" class="h-5 w-5"></i> <span class="font-semibold text-lg">Request Sent</span> </button>
                </div>

                <!-- Roles & Badges -->
                <div class="space-y-3">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center space-x-2"> <i data-feather="star" class="text-yellow-500"></i> <span>Roles & Badges</span> </h2>
                    <div class="text-gray-500 italic p-4 bg-gray-50 border border-gray-200 rounded-2xl text-center"> Not Assigned </div>
                </div>

                <!-- Social Links -->
                <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 space-y-4">
                    <h2 class="text-xl font-bold text-gray-900">Social Links</h2>
                    <div class="flex justify-between items-center"> <div class="flex items-center space-x-3 text-gray-700"> <i data-feather="instagram" class="h-5 w-5"></i> <span class="font-medium">Instagram</span> </div> <span id="profile-instagram" class="font-medium text-gray-900 italic"></span> </div>
                    <div class="flex justify-between items-center"> <div class="flex items-center space-x-3 text-gray-700"> <i data-feather="linkedin" class="h-5 w-5"></i> <span class="font-medium">LinkedIn</span> </div> <span id="profile-linkedin" class="font-medium text-gray-900 italic"></span> </div>
                </div>

                 <!-- User's Posts Section -->
                 <div class="space-y-3 pt-4 border-t border-gray-200">
                     <h2 class="text-xl font-bold text-gray-900">Posts</h2>
                     <div id="user-posts-container" class="space-y-6">
                         <div id="posts-loading" class="text-center py-6 text-gray-500"> <p>Loading posts...</p> </div>
                         <!-- Posts injected here -->
                     </div>
                 </div>

             </div><!-- End #profile-content -->

        </main>

    </div>

     <!-- Friends List Modal -->
     <div id="friends-modal" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 items-center justify-center p-4">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm max-h-[80vh] flex flex-col">
             <div class="flex justify-between items-center p-4 border-b border-gray-200"> <h2 class="text-lg font-semibold">Friends List</h2> <button id="close-friends-modal" class="p-1 rounded-full text-gray-500 hover:bg-gray-100"> <i data-feather="x"></i> </button> </div>
             <div id="friends-modal-body" class="p-4 overflow-y-auto"> <p class="text-gray-500 text-center py-4">Loading friends...</p> </div>
         </div>
     </div>

    <!-- ===== Supabase & App Logic ===== -->
    <script>
        // --- 1. SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://eikriuddsuguybvvyzjl.supabase.co'; // REPLACE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpa3JpdWRkc3VndXlidnZ5empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjIxNTAsImV4cCI6MjA3MzY5ODE1MH0.HNh2gGO8nWzAjxh5Oa3cs_8WKaq9mq9TyLCvPOkcr2c'; // REPLACE
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global variables ---
        let currentAuthUser = null; // The person VIEWING the profile (Supabase auth user)
        let currentUserOwnProfile = null; // The profile data of the VIEWER (from users table)
        let viewedUserProfile = null; // The profile data BEING VIEWED
        let viewedUserId = null; // The 'id' (int4) of the profile being viewed

        // Tick mark URLs
        const tickImages = { blue: "https://i.ibb.co/kgJpMCHr/blue.png", silver: "https://i.ibb.co/gLJLF9Z2/silver.png", gold: "https://i.ibb.co/Q2C7MrM/gold.png", black: "https://i.ibb.co/zVNSNzrK/black.png", green: "https://i.ibb.co/SXGL4Nq0/green.png" };

        // --- Elements ---
        const profileLoading = document.getElementById('profile-loading');
        const profileContent = document.getElementById('profile-content');
        const userPostsContainer = document.getElementById('user-posts-container');
        const postsLoading = document.getElementById('posts-loading');
        const friendsModal = document.getElementById('friends-modal');
        const friendsModalBody = document.getElementById('friends-modal-body');
        const addFriendButton = document.getElementById('add-friend-button');
        const requestSentButton = document.getElementById('request-sent-button');

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            viewedUserId = urlParams.get('id'); 

            if (!viewedUserId || isNaN(parseInt(viewedUserId))) { showError("Invalid or missing user ID in URL."); return; }
            viewedUserId = parseInt(viewedUserId); 

            const { data: { session }, error: sessionError } = await _supabase.auth.getSession();
            if (sessionError) console.error("Session Error:", sessionError);
            
            if (session) {
                currentAuthUser = session.user;
                // Fetch the VIEWING user's profile data (including their own 'id')
                await fetchCurrentUserOwnProfile(currentAuthUser.id); 

                // --- REDIRECT CHECK ---
                if (currentUserOwnProfile && currentUserOwnProfile.id === viewedUserId) {
                    console.log("Viewing own profile, redirecting...");
                    window.location.replace('myprofile.html'); // Use replace to avoid history stack
                    return; // Stop further execution
                }
            }

            await loadProfileData(viewedUserId);
            if (viewedUserProfile?.auth_id) { await loadUserPosts(viewedUserProfile.auth_id); } 
            else if (!profileLoading.textContent.includes("Error")) { postsLoading.innerHTML = `<p class="text-center text-gray-500">Could not load posts.</p>`; }

            setupEventListeners();
            feather.replace(); 
        });

        // --- 3. FETCH CURRENT USER'S OWN PROFILE ('id' needed for redirect check) ---
         async function fetchCurrentUserOwnProfile(authId) {
             if (!authId) return;
             try {
                const { data, error } = await _supabase
                    .from('users')
                    .select('id') // Select only the 'id' (student ID)
                    .eq('auth_id', authId)
                    .single();
                if (error) throw error;
                currentUserOwnProfile = data; // Store { id: 12345 }
             } catch (error) {
                  console.error("Error fetching current user's own profile:", error.message);
                  // Allow proceeding, but redirect might not work if this fails
             }
         }


        // --- 4. LOAD PROFILE DATA ---
        async function loadProfileData(userId) {
            profileLoading.style.display = 'block'; profileContent.classList.add('hidden');
            try {
                const { data, error } = await _supabase.from('users').select('id, auth_id, name, img, course, bio, friend_count, tick, instagram, linkedin, role').eq('id', userId).single();
                if (error) { if (error.code === 'PGRST116') throw new Error(`User profile not found.`); throw error; }
                if (!data) throw new Error(`User profile not found.`);
                viewedUserProfile = data; 

                // Populate UI
                document.getElementById('profile-picture').src = data.img || `https://placehold.co/100x100/A8E063/305B1C?text=${data.name ? data.name.charAt(0) : '?'}`;
                document.getElementById('profile-name').textContent = data.name || 'Campus User';
                document.getElementById('profile-role').textContent = data.role || 'Role Not Set';
                document.getElementById('profile-bio').textContent = data.bio || 'No bio provided.';
                document.getElementById('profile-friend-count').textContent = data.friend_count ?? 0; // Use nullish coalescing
                document.getElementById('profile-course').textContent = data.course?.toUpperCase() || '-'; // Uppercase + fallback

                const tickElement = document.getElementById('profile-tick');
                if (data.tick && tickImages[data.tick.toLowerCase()]) { tickElement.src = tickImages[data.tick.toLowerCase()]; tickElement.alt = `${data.tick} Tick`; tickElement.classList.remove('hidden'); } 
                else { tickElement.classList.add('hidden'); }

                const instaSpan = document.getElementById('profile-instagram');
                if (data.instagram && data.instagram !== 'EMPTY') { instaSpan.innerHTML = `<a href="https://instagram.com/${data.instagram.replace('@','')}" target="_blank" class="text-primary-600 hover:underline">@${data.instagram.replace('@','')}</a>`; instaSpan.className = 'font-medium text-primary-600'; } 
                else { instaSpan.textContent = 'Not Set'; instaSpan.className = 'font-medium text-gray-400 italic'; }
                
                const linkedSpan = document.getElementById('profile-linkedin');
                 if (data.linkedin && data.linkedin !== 'EMPTY') { linkedSpan.textContent = data.linkedin; linkedSpan.className = 'font-medium text-gray-900'; } 
                 else { linkedSpan.textContent = 'Not Set'; linkedSpan.className = 'font-medium text-gray-400 italic'; }

                profileLoading.style.display = 'none';
                profileContent.classList.remove('hidden');

                // Check friendship status AFTER profile loads to update Add Friend button
                 if (currentAuthUser) {
                     await checkFriendshipStatus();
                 }


            } catch (error) { showError(`Error loading profile: ${error.message}`); }
        }

        // --- 5. LOAD USER POSTS ---
        async function loadUserPosts(userAuthId) { /* ... (same as before) ... */ }

        // --- 6. CREATE MINI POST HTML ---
        function createMiniPostHTML(post) { /* ... (same as before) ... */ }

        // --- 7. EVENT LISTENERS ---
        function setupEventListeners() {
            const moreOptionsBtn = document.getElementById('more-options-btn');
            const moreOptionsMenu = document.getElementById('more-options-menu');
            moreOptionsBtn.addEventListener('click', (event) => { event.stopPropagation(); moreOptionsMenu.classList.toggle('hidden'); if (!moreOptionsMenu.classList.contains('hidden')) feather.replace(); });
            window.addEventListener('click', (event) => { if (!moreOptionsMenu.classList.contains('hidden') && !moreOptionsMenu.contains(event.target) && !moreOptionsBtn.contains(event.target)) { moreOptionsMenu.classList.add('hidden'); } });
            document.getElementById('share-profile-link').addEventListener('click', (e) => { e.preventDefault(); alert('Sharing profile... (Not implemented)'); moreOptionsMenu.classList.add('hidden'); });
            document.getElementById('report-profile-link').addEventListener('click', (e) => { e.preventDefault(); alert('Reporting profile... (Not implemented)'); moreOptionsMenu.classList.add('hidden'); });
            const friendsListButton = document.getElementById('friends-list-button');
            const friendsCountButton = document.getElementById('friends-count-button'); 
            const closeFriendsModalButton = document.getElementById('close-friends-modal');
             friendsListButton.addEventListener('click', openFriendsModal);
             friendsCountButton.addEventListener('click', openFriendsModal);
             closeFriendsModalButton.addEventListener('click', closeFriendsModal);
             friendsModal.addEventListener('click', (event) => { if (event.target === friendsModal) closeFriendsModal(); }); 
             // Modified Add Friend Listener
             addFriendButton.addEventListener('click', sendFriendRequest); 
        }

         // --- 8. FRIENDS LIST MODAL ---
         async function openFriendsModal() { /* ... (same as before) ... */ }
         function closeFriendsModal() { /* ... (same as before) ... */ }

         // --- 9. SEND FRIEND REQUEST (NEW/MODIFIED) ---
         async function sendFriendRequest() {
              if (!currentAuthUser) { alert("Please log in to send friend requests."); return; }
              if (!viewedUserProfile || !viewedUserProfile.auth_id) { alert("Cannot send request: User data missing."); return; }
              if (currentAuthUser.id === viewedUserProfile.auth_id) { alert("You cannot send a friend request to yourself."); return; } // Prevent self-request

              addFriendButton.disabled = true;
              addFriendButton.innerHTML = `<div class="spinner w-5 h-5 mx-auto"></div>`; // Show spinner

             try {
                 // Check if a request already exists between these two users (in either direction)
                 const { data: existingRequest, error: checkError } = await _supabase
                     .from('friend_requests')
                     .select('id, status')
                     .or(`(sender_id.eq.${currentAuthUser.id},receiver_id.eq.${viewedUserProfile.auth_id}),(sender_id.eq.${viewedUserProfile.auth_id},receiver_id.eq.${currentAuthUser.id})`)
                     .maybeSingle(); // Check both directions

                 if (checkError) throw checkError;

                 if (existingRequest) {
                     if (existingRequest.status === 'pending') {
                          alert("A friend request is already pending between you two.");
                          updateFriendButtonState('pending'); // Update button to show pending
                     } else if (existingRequest.status === 'accepted') {
                          alert("You are already friends!");
                          updateFriendButtonState('friends'); // Update button to show friends (optional)
                     } else {
                          // Could be rejected or cancelled - potentially allow sending new request
                           await insertRequest();
                     }
                     return; // Stop execution if pending or accepted
                 }

                  // If no existing request, insert a new one
                 await insertRequest();

             } catch (error) {
                 console.error("Error sending friend request:", error);
                 alert("Could not send friend request. " + (error.message.includes('duplicate key') ? 'A request might already exist.' : 'Please try again.'));
                 // Reset button on error
                 addFriendButton.disabled = false;
                 addFriendButton.innerHTML = `<i data-feather="user-plus" class="h-5 w-5"></i> <span class="font-semibold text-lg">Add Friend</span>`;
                 feather.replace(); // Re-render icon
             }
         }
        
         async function insertRequest() {
             const { error: insertError } = await _supabase
                 .from('friend_requests')
                 .insert({
                     sender_id: currentAuthUser.id,
                     receiver_id: viewedUserProfile.auth_id,
                     status: 'pending' 
                 });

             if (insertError) {
                  // Handle potential unique constraint violation if race condition occurred
                  if (insertError.code === '23505') { // unique_violation
                     alert("A friend request is already pending.");
                     updateFriendButtonState('pending');
                  } else {
                      throw insertError; // Re-throw other errors
                  }
             } else {
                 console.log("Friend request sent successfully.");
                 alert("Friend request sent!");
                 updateFriendButtonState('pending'); // Update button to show request sent
             }
         }

         // --- 10. CHECK FRIENDSHIP STATUS (NEW - Basic) ---
         // This function updates the 'Add Friend' button based on existing requests or friendships
         async function checkFriendshipStatus() {
              if (!currentAuthUser || !viewedUserProfile || currentAuthUser.id === viewedUserProfile.auth_id) {
                 // Hide Add Friend button if viewing own profile or not logged in
                 addFriendButton.classList.add('hidden');
                 return; 
              }

             try {
                 // Check for existing request (pending)
                  const { data: request, error: reqError } = await _supabase
                     .from('friend_requests')
                     .select('id, status, sender_id')
                     .or(`(sender_id.eq.${currentAuthUser.id},receiver_id.eq.${viewedUserProfile.auth_id}),(sender_id.eq.${viewedUserProfile.auth_id},receiver_id.eq.${currentAuthUser.id})`)
                     .eq('status', 'pending') // Only look for pending requests
                     .maybeSingle();

                 if (reqError) throw reqError;

                 if (request) {
                      updateFriendButtonState('pending');
                     return; // Stop if pending request found
                 }

                 // Check for existing friendship (accepted)
                  // Query friendships table using LEAST/GREATEST logic
                 const user1 = currentAuthUser.id < viewedUserProfile.auth_id ? currentAuthUser.id : viewedUserProfile.auth_id;
                 const user2 = currentAuthUser.id > viewedUserProfile.auth_id ? currentAuthUser.id : viewedUserProfile.auth_id;

                  const { data: friendship, error: friendError } = await _supabase
                     .from('friendships')
                     .select('id')
                     .eq('user1_id', user1)
                     .eq('user2_id', user2)
                     .maybeSingle();

                 if (friendError) throw friendError;

                 if (friendship) {
                      updateFriendButtonState('friends'); 
                     return; 
                 }

                 // If neither pending request nor friendship, show default Add Friend button
                  updateFriendButtonState('none');

             } catch (error) {
                 console.error("Error checking friendship status:", error);
                 // Default to showing Add Friend button on error
                  updateFriendButtonState('none');
             }
         }

         // --- 11. UPDATE FRIEND BUTTON UI (NEW) ---
         function updateFriendButtonState(status) {
             addFriendButton.classList.add('hidden'); // Hide all buttons initially
             requestSentButton.classList.add('hidden');
             // Add placeholders for 'Friends' or 'Accept Request' buttons if needed later

             if (status === 'pending') {
                 requestSentButton.classList.remove('hidden');
             } else if (status === 'friends') {
                 // Example: Show a "Friends" button (currently hidden)
                 // document.getElementById('friends-button').classList.remove('hidden'); 
                 // For now, just hide 'Add Friend' and 'Request Sent'
                 console.log("Status: Friends (Button placeholder)");
             } else { // status === 'none' or error
                 addFriendButton.classList.remove('hidden');
                 addFriendButton.disabled = false;
                 addFriendButton.innerHTML = `<i data-feather="user-plus" class="h-5 w-5"></i> <span class="font-semibold text-lg">Add Friend</span>`;
                 feather.replace(); // Ensure icon is rendered
             }
         }


        // --- 12. HELPERS ---
        function showError(message) { /* ... (same as before) ... */ }
        function formatTimeAgo(dateString) { /* ... (same as before) ... */ }
        
    </script>

</body>
</html>
