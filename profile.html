<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'primary': { // Green Theme
                            '50': '#f7fbf4','100': '#eef8e9','200': '#dcf1d3','300': '#c3e7b3',
                            '400': '#a6d98e','500': '#87c964','600': '#56ab2f','700': '#458a26',
                            '800': '#396f21','900': '#305b1c','950': '#1a320f',
                        },
                    }
                },
            },
        };
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; /* bg-slate-50 */ }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        i[data-feather], svg.feather { width: 24px; height: 24px; stroke: currentColor; }
        .spinner { border: 2px solid rgba(0, 0, 0, 0.1); border-left-color: #56ab2f; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Style for tick mark image */
        .tick-mark { width: 1.5rem; height: 1.5rem; /* w-6 h-6 */ vertical-align: middle; margin-left: 4px;}
        /* Modal styles */
        .modal { display: none; /* Hidden by default */ }
        .modal.active { display: flex; /* Show when active */ }
    </style>
</head>
<body class="antialiased bg-slate-50">

    <div class="relative min-h-screen w-full md:max-w-md md:mx-auto md:shadow-2xl md:overflow-hidden bg-white">

        <header class="fixed top-0 left-0 right-0 z-40 p-4 flex justify-between items-center md:max-w-md md:mx-auto">
            <a href="javascript:history.back()" class="p-2 rounded-full transition-all bg-white/50 hover:bg-white/90 active:scale-90 backdrop-blur-sm shadow-md">
                <i data-feather="arrow-left" class="text-gray-900"></i>
            </a>
            
            <button id="more-options-btn" class="p-2 rounded-full transition-all bg-white/50 hover:bg-white/90 active:scale-90 backdrop-blur-sm shadow-md">
                <i data-feather="more-vertical" class="text-gray-900"></i>
            </button>
        </header>

        <div id="more-options-menu" class="hidden absolute top-16 right-4 z-50 w-56 bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden">
            <a href="#" id="share-profile-link" class="flex items-center space-x-3 px-4 py-3 text-gray-700 hover:bg-gray-100 transition-colors">
                <i data-feather="share-2" class="w-5 h-5"></i>
                <span>Share Profile</span>
            </a>
            <a href="#" id="report-profile-link" class="flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 transition-colors">
                <i data-feather="flag" class="w-5 h-5"></i>
                <span>Report Profile</span>
            </a>
        </div>

        <main id="main-content" class="px-6 space-y-6 pb-12 pt-20 overflow-y-auto h-screen no-scrollbar">
            
             <div id="profile-loading" class="text-center py-10 text-gray-500">
                 <div class="spinner mx-auto mb-2"></div>
                 <p>Loading profile...</p>
            </div>

            <div id="profile-content" class="hidden space-y-6">

                <div class="flex flex-col items-center">
                    <img id="profile-picture" src="https://placehold.co/100x100/A8E063/305B1C?text=?" alt="Profile Picture" class="w-24 h-24 rounded-full border-4 border-primary-600 bg-gray-200 object-cover">
                    <div class="flex items-center space-x-1.5 mt-4">
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-900">User Name</h2>
                        <img id="profile-tick" src="" alt="Verification Tick" class="tick-mark hidden">
                    </div>
                    <p id="profile-role" class="text-lg text-gray-500">Role</p>
                    <p id="profile-bio" class="text-base text-gray-700 mt-2 text-center max-w-sm"></p>
                </div>

                <div class="flex justify-center items-center divide-x divide-gray-200 w-full bg-gray-50 py-4 rounded-2xl border border-gray-200">
                    <div class="flex flex-col items-center w-1/2 cursor-pointer" id="friends-count-button">
                        <span id="profile-friend-count" class="text-2xl font-bold text-gray-900">0</span>
                        <span class="text-sm text-gray-500">Friends</span>
                    </div>
                    <div class="flex flex-col items-center text-center w-1/2">
                        <span id="profile-course" class="text-2xl font-bold text-gray-900">-</span>
                        <span class="text-sm text-gray-500">Course</span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button id="friends-list-button" class="w-full bg-white border border-primary-600 text-primary-600 p-4 rounded-xl flex justify-center items-center space-x-2 shadow-sm transition-all duration-300 hover:bg-primary-50 active:scale-95">
                        <i data-feather="users" class="h-5 w-5"></i>
                        <span class="font-semibold text-lg">Friends List</span>
                    </button>
                    
                    <button id="add-friend-button" class="w-full bg-gradient-to-r from-primary-600 to-primary-700 text-white p-4 rounded-xl flex justify-center items-center space-x-2 shadow-lg shadow-primary-500/30 transition-all duration-300 hover:shadow-xl hover:-translate-y-0.5 active:scale-95">
                        <i data-feather="user-plus" class="h-5 w-5"></i>
                        <span class="font-semibold text-lg">Add Friend</span>
                    </button>
                     </div>


                <div class="space-y-3">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center space-x-2">
                        <i data-feather="star" class="text-yellow-500"></i>
                        <span>Roles & Badges</span>
                    </h2>
                    <div class="text-gray-500 italic p-4 bg-gray-50 border border-gray-200 rounded-2xl text-center">
                        Not Assigned
                    </div>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 space-y-4">
                    <h2 class="text-xl font-bold text-gray-900">Social Links</h2>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3 text-gray-700">
                            <i data-feather="instagram" class="h-5 w-5"></i>
                            <span class="font-medium">Instagram</span>
                        </div>
                        <span id="profile-instagram" class="font-medium text-gray-900 italic"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3 text-gray-700">
                            <i data-feather="linkedin" class="h-5 w-5"></i>
                            <span class="font-medium">LinkedIn</span>
                        </div>
                         <span id="profile-linkedin" class="font-medium text-gray-900 italic"></span>
                    </div>
                </div>

                 <div class="space-y-3 pt-4 border-t border-gray-200">
                     <h2 class="text-xl font-bold text-gray-900">Posts</h2>
                     <div id="user-posts-container" class="space-y-6">
                         <div id="posts-loading" class="text-center py-6 text-gray-500">
                             <p>Loading posts...</p>
                         </div>
                         </div>
                 </div>

             </div></main>

    </div>

     <div id="friends-modal" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 items-center justify-center p-4">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm max-h-[80vh] flex flex-col">
             <div class="flex justify-between items-center p-4 border-b border-gray-200">
                 <h2 class="text-lg font-semibold">Friends List</h2>
                 <button id="close-friends-modal" class="p-1 rounded-full text-gray-500 hover:bg-gray-100">
                     <i data-feather="x"></i>
                 </button>
             </div>
             <div id="friends-modal-body" class="p-4 overflow-y-auto">
                 <p class="text-gray-500 text-center py-4">Loading friends...</p>
             </div>
         </div>
     </div>

    <script>
        // --- 1. SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://eikriuddsuguybvvyzjl.supabase.co'; // REPLACE
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpa3JpdWRkc3VndXlidnZ5empsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMjIxNTAsImV4cCI6MjA3MzY5ODE1MH0.HNh2gGO8nWzAjxh5Oa3cs_8WKaq9mq9TyLCvPOkcr2c'; // REPLACE
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global variables ---
        let currentAuthUser = null; // The person VIEWING the profile
        let viewedUserProfile = null; // The profile data BEING VIEWED
        let viewedUserId = null; // The 'id' (int4) of the profile being viewed

        // Tick mark URLs
        const tickImages = {
             blue: "https://i.ibb.co/kgJpMCHr/blue.png",
             silver: "https://i.ibb.co/gLJLF9Z2/silver.png",
             gold: "https://i.ibb.co/Q2C7MrM/gold.png",
             black: "https://i.ibb.co/zVNSNzrK/black.png",
             green: "https://i.ibb.co/SXGL4Nq0/green.png"
        };

        // --- Elements ---
        const profileLoading = document.getElementById('profile-loading');
        const profileContent = document.getElementById('profile-content');
        const userPostsContainer = document.getElementById('user-posts-container');
        const postsLoading = document.getElementById('posts-loading');
        const friendsModal = document.getElementById('friends-modal');
        const friendsModalBody = document.getElementById('friends-modal-body');

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            viewedUserId = urlParams.get('id'); // Get the target user's 'id' (int4)

            if (!viewedUserId || isNaN(parseInt(viewedUserId))) {
                showError("Invalid or missing user ID in URL.");
                return;
            }
            viewedUserId = parseInt(viewedUserId); // Ensure it's a number

            // Check who is viewing the profile
            const { data: { session }, error: sessionError } = await _supabase.auth.getSession();
            if (sessionError) console.error("Session Error:", sessionError);
            if (session) currentAuthUser = session.user;

            // Load profile data and posts
            await loadProfileData(viewedUserId);
            // We need auth_id to fetch posts
            if (viewedUserProfile?.auth_id) {
                 await loadUserPosts(viewedUserProfile.auth_id);
            } else if (!profileLoading.textContent.includes("Error")) { 
                 // Only show post loading error if profile loaded okay
                 postsLoading.innerHTML = `<p class="text-center text-gray-500">Could not load posts (missing user auth data).</p>`;
            }

            setupEventListeners();
            feather.replace(); 
        });

        // --- 3. LOAD PROFILE DATA ---
        async function loadProfileData(userId) {
            profileLoading.style.display = 'block';
            profileContent.classList.add('hidden');
            try {
                const { data, error } = await _supabase
                    .from('users')
                    .select('id, auth_id, name, img, course, bio, friend_count, tick, instagram, linkedin, role')
                    .eq('id', userId) // Match the 'id' column
                    .single();

                if (error) { 
                     if (error.code === 'PGRST116') throw new Error(`User profile with ID ${userId} not found.`);
                     throw error; 
                }
                if (!data) throw new Error(`User profile with ID ${userId} not found.`);

                viewedUserProfile = data; // Store the fetched profile data

                // Populate UI
                document.getElementById('profile-picture').src = data.img || `https://placehold.co/100x100/A8E063/305B1C?text=${data.name ? data.name.charAt(0) : '?'}`;
                document.getElementById('profile-name').textContent = data.name || 'Campus User';
                document.getElementById('profile-role').textContent = data.role || 'Role Not Set'; // Display role
                document.getElementById('profile-bio').textContent = data.bio || 'No bio provided.';
                document.getElementById('profile-friend-count').textContent = data.friend_count || 0;
                document.getElementById('profile-course').textContent = data.course || '-';

                // Display Tick Mark
                const tickElement = document.getElementById('profile-tick');
                if (data.tick && tickImages[data.tick.toLowerCase()]) {
                     tickElement.src = tickImages[data.tick.toLowerCase()];
                     tickElement.alt = `${data.tick} Tick`;
                     tickElement.classList.remove('hidden');
                } else {
                     tickElement.classList.add('hidden');
                }

                // Social Links
                const instaSpan = document.getElementById('profile-instagram');
                if (data.instagram && data.instagram !== 'EMPTY') {
                    instaSpan.innerHTML = `<a href="https://instagram.com/${data.instagram.replace('@','')}" target="_blank" class="text-primary-600 hover:underline">@${data.instagram.replace('@','')}</a>`;
                     instaSpan.classList.remove('italic', 'text-gray-400');
                     instaSpan.classList.add('text-primary-600');
                } else {
                     instaSpan.textContent = 'Not Set';
                     instaSpan.classList.add('italic', 'text-gray-400');
                     instaSpan.classList.remove('text-primary-600');
                }
                const linkedSpan = document.getElementById('profile-linkedin');
                 if (data.linkedin && data.linkedin !== 'EMPTY') {
                     // Basic display - assumes it's a username/handle, not full URL yet
                     linkedSpan.textContent = data.linkedin; 
                     linkedSpan.classList.remove('italic', 'text-gray-400');
                     linkedSpan.classList.add('text-gray-900'); // Keep it less prominent than insta link maybe
                } else {
                     linkedSpan.textContent = 'Not Set';
                     linkedSpan.classList.add('italic', 'text-gray-400');
                     linkedSpan.classList.remove('text-gray-900');
                }

                profileLoading.style.display = 'none';
                profileContent.classList.remove('hidden');

            } catch (error) {
                showError(`Error loading profile: ${error.message}`);
            }
        }

        // --- 4. LOAD USER POSTS ---
        async function loadUserPosts(userAuthId) {
             postsLoading.style.display = 'block';
             userPostsContainer.innerHTML = ''; // Clear previous
             try {
                // Fetch posts for this user's auth_id
                 const { data: posts, error } = await _supabase
                    .from('posts')
                    .select(`*, users:user_id!inner(name, img)`) // Select user data too
                    .eq('user_id', userAuthId)
                    .order('created_at', { ascending: false });

                 if (error) throw error;

                 postsLoading.style.display = 'none';

                 if (posts.length === 0) {
                     userPostsContainer.innerHTML = `<p class="text-center text-gray-500 py-6">This user hasn't posted yet.</p>`;
                 } else {
                     // Render posts (using a simplified display, no interactions for now)
                     const postsHtml = posts.map(post => createMiniPostHTML(post)).join('');
                     userPostsContainer.innerHTML = postsHtml;
                     feather.replace(); // Render icons in posts
                 }
                 
             } catch (error) {
                 console.error("Error fetching user posts:", error);
                 postsLoading.innerHTML = `<p class="text-center text-red-500">Could not load posts.</p>`;
             }
        }

        // --- 5. CREATE MINI POST HTML (Simplified for profile view) ---
        function createMiniPostHTML(post) {
             const authorName = post.is_anonymous ? 'Campus Confession' : (post.users?.name || 'Unknown User'); 
             const authorAvatar = post.is_anonymous ? `<div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center flex-shrink-0"><i data-feather="eye-off" class="text-white w-5 h-5"></i></div>` : `<img src="${post.users?.img || `https://placehold.co/40x40/DCEFD3/305B1C?text=${authorName.charAt(0)}`}" alt="Profile" class="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0">`; 
             const postTimestamp = formatTimeAgo(post.created_at); 
             const headerClass = post.is_anonymous ? 'bg-gray-800' : 'bg-white'; 
             const headerText = post.is_anonymous ? 'text-white' : 'text-gray-900'; 
             const subText = post.is_anonymous ? 'text-gray-400' : 'text-gray-500'; 

             let postBody = '';
             switch(post.post_type) {
                 case 'photo': postBody = ` ${post.content ? `<p class="px-4 pb-3 text-gray-800">${post.content}</p>` : ''} <img src="${post.media_url}" alt="Post media" class="w-full object-cover bg-gray-100 max-h-60 rounded-b-lg"> `; break; // Max height for profile feed
                 case 'poll': postBody = `<p class="px-4 pb-3 font-semibold text-lg text-gray-900">${post.content}</p><p class="px-4 pb-4 text-sm text-gray-500 italic">(Poll - View full post to vote)</p>`; break; // Indicate poll
                 case 'text': case 'anonymous': default: postBody = `<p class="px-4 pb-4 text-gray-800 text-base">${post.content}</p>`; 
             }

             // Simplified footer showing counts only
             const footer = `
                 <div class="flex justify-end space-x-4 border-t border-gray-100 px-4 py-2 text-sm text-gray-500">
                     <span class="flex items-center"><i data-feather="heart" class="w-4 h-4 mr-1"></i> ${post.like_count}</span>
                     <span class="flex items-center"><i data-feather="message-square" class="w-4 h-4 mr-1"></i> ${post.comment_count}</span>
                 </div>
             `;

             return `
                 <a href="post.html?id=${post.id}" class="block bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow"> 
                     <div class="flex items-center space-x-3 p-4 ${headerClass}"> 
                         ${authorAvatar} 
                         <div> 
                             <p class="font-semibold ${headerText}">${authorName}</p> 
                             <p class="text-xs ${subText}">${postTimestamp}</p> 
                         </div> 
                     </div> 
                     ${postBody} 
                     ${footer}
                 </a>
             `;
        }


        // --- 6. EVENT LISTENERS ---
        function setupEventListeners() {
            // More Options Menu
            const moreOptionsBtn = document.getElementById('more-options-btn');
            const moreOptionsMenu = document.getElementById('more-options-menu');
            moreOptionsBtn.addEventListener('click', (event) => { event.stopPropagation(); moreOptionsMenu.classList.toggle('hidden'); if (!moreOptionsMenu.classList.contains('hidden')) feather.replace(); });
            window.addEventListener('click', (event) => { if (!moreOptionsMenu.classList.contains('hidden') && !moreOptionsMenu.contains(event.target) && !moreOptionsBtn.contains(event.target)) { moreOptionsMenu.classList.add('hidden'); } });

            // Share/Report Links (Placeholders)
             document.getElementById('share-profile-link').addEventListener('click', (e) => { e.preventDefault(); alert('Sharing profile... (Not implemented)'); moreOptionsMenu.classList.add('hidden'); });
             document.getElementById('report-profile-link').addEventListener('click', (e) => { e.preventDefault(); alert('Reporting profile... (Not implemented)'); moreOptionsMenu.classList.add('hidden'); });

            // Friends List Button (Opens Modal)
            const friendsListButton = document.getElementById('friends-list-button');
            const friendsCountButton = document.getElementById('friends-count-button'); // Also trigger from count
            const closeFriendsModalButton = document.getElementById('close-friends-modal');

             friendsListButton.addEventListener('click', openFriendsModal);
             friendsCountButton.addEventListener('click', openFriendsModal);
             closeFriendsModalButton.addEventListener('click', closeFriendsModal);
             friendsModal.addEventListener('click', (event) => { if (event.target === friendsModal) closeFriendsModal(); }); // Close on backdrop click

             // Add Friend Button (Placeholder)
             document.getElementById('add-friend-button').addEventListener('click', () => {
                 if (!currentAuthUser) { alert("Please log in to add friends."); return; }
                 alert(`Sending friend request to ${viewedUserProfile?.name}... (Not implemented)`);
                 // Here you would call Supabase to insert into friend_requests
             });
        }

         // --- 7. FRIENDS LIST MODAL ---
         async function openFriendsModal() {
             if (!viewedUserProfile || !viewedUserProfile.auth_id) { alert("Cannot load friends list: User data missing."); return; }

             friendsModalBody.innerHTML = '<p class="text-gray-500 text-center py-4">Loading friends...</p>';
             friendsModal.classList.add('active');
             feather.replace(); // Ensure close icon is rendered

             try {
                 // Query friendships table for the viewed user
                 // Need to fetch where user1_id OR user2_id matches the viewed user's auth_id
                  const { data: friendships, error: friendsError } = await _supabase
                     .from('friendships')
                     .select(`
                        user1:user1_id (auth_id, name, img), 
                        user2:user2_id (auth_id, name, img)
                     `)
                     .or(`user1_id.eq.${viewedUserProfile.auth_id},user2_id.eq.${viewedUserProfile.auth_id}`);
                 
                 if (friendsError) throw friendsError;

                 if (friendships.length === 0) {
                      friendsModalBody.innerHTML = '<p class="text-gray-500 text-center py-4">No friends to show yet.</p>';
                     return;
                 }

                 // Extract the friend profiles (the one who ISN'T the viewed user)
                 const friends = friendships.map(f => {
                     return f.user1.auth_id === viewedUserProfile.auth_id ? f.user2 : f.user1;
                 });

                 // Render the friends list
                 friendsModalBody.innerHTML = friends.map(friend => `
                     <a href="profile.html?id=${friend.id /* Assuming friend object has 'id' (int4) */}" class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-lg">
                         <img src="${friend.img || `https://placehold.co/40x40/DCEFD3/305B1C?text=${friend.name ? friend.name.charAt(0) : '?'}`}" alt="${friend.name}" class="w-10 h-10 rounded-full bg-gray-200">
                         <span class="font-medium text-gray-800">${friend.name || 'Campus User'}</span>
                     </a>
                 `).join('');

             } catch (error) {
                 console.error("Error fetching friends list:", error);
                 friendsModalBody.innerHTML = '<p class="text-red-500 text-center py-4">Could not load friends list.</p>';
             }
         }

         function closeFriendsModal() {
             friendsModal.classList.remove('active');
             friendsModalBody.innerHTML = ''; // Clear content
         }

        // --- 8. HELPERS ---
        function showError(message) {
             profileLoading.innerHTML = `<p class="text-center text-red-500 font-semibold">${message}</p>`;
             profileLoading.style.display = 'block';
             profileContent.classList.add('hidden');
             postsLoading.innerHTML = ''; // Clear posts loading message too
        }

        function formatTimeAgo(dateString) { 
             const date = new Date(dateString); const now = new Date(); const seconds = Math.floor((now - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "mo ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m ago"; if (seconds < 5) return "just now"; return Math.floor(seconds) + "s ago";
        }
        
    </script>

</body>
</html>
